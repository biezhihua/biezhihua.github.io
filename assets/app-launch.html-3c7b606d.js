import{_ as o,C as c,Y as l,Z as i,$ as n,a0 as s,a1 as p,a2 as u}from"./framework-301d0703.js";const k="/learn-android/aosp/app-launch-1.png",r="/learn-android/aosp/app-launch-2.png",d="/learn-android/aosp/app-launch-3.png",v="/learn-android/aosp/app-launch-4.png",m="/learn-android/aosp/app-launch-5.png",b="/learn-android/aosp/app-launch-6.png",y="/learn-android/aosp/app-launch-7.png",t="/learn-android/aosp/app-launch-13.png",w="/learn-android/aosp/app-launch-8.png",f="/learn-android/aosp/app-launch-9.png",g="/learn-android/aosp/app-launch-10.png",h="/learn-android/aosp/app-launch-11.png",A="/learn-android/aosp/app-launch-12.png",T="/learn-android/aosp/app-launch-14.png",I="/learn-android/aosp/app-launch-15.png",S="/learn-android/aosp/app-launch-16.png",R="/learn-android/aosp/app-launch-17.png",C="/learn-android/aosp/app-launch-18.png",_="/learn-android/aosp/app-launch-19.png",L="/learn-android/aosp/app-launch-20.png",P="/learn-android/aosp/app-launch-22.png",N="/learn-android/aosp/app-launch-21.png",E="/learn-android/aosp/app-launch-23.png",V="/learn-android/aosp/app-launch-24.png",j="/learn-android/aosp/app-launch-25.png",D="/learn-android/aosp/app-launch-26.png",M="/learn-android/aosp/app-launch-31.png",x="/learn-android/aosp/app-launch-27.png",B="/learn-android/aosp/app-launch-28.png",F="/learn-android/aosp/app-launch-29.png",q="/learn-android/aosp/app-launch-30.png",W="/learn-android/aosp/app-launch-32.png",O="/learn-android/aosp/app-launch-33.png",G="/learn-android/aosp/app-launch-34.png",z="/learn-android/aosp/app-launch-35.png",U="/learn-android/aosp/app-launch-36.png",e="/learn-android/aosp/app-launch-37.png",Z="/learn-android/aosp/app-launch-39.png",H="/learn-android/aosp/app-launch-40.png",Q="/learn-android/aosp/app-launch-41.png",K="/learn-android/aosp/app-launch-42.png",Y="/learn-android/aosp/app-launch-43.png",J="/learn-android/aosp/app-launch-44.png",X="/learn-android/aosp/app-launch-45.png",$="/learn-android/aosp/app-launch-46.png",nn="/learn-android/aosp/app-launch-47.png",sn={},an=n("h1",{id:"android-aosp-应用启动全流程分析-转载-加工",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#android-aosp-应用启动全流程分析-转载-加工","aria-hidden":"true"},"#"),s(" Android | AOSP | 应用启动全流程分析 | 转载&加工")],-1),pn=n("h2",{id:"前言1",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#前言1","aria-hidden":"true"},"#"),s(" 前言1")],-1),tn={href:"https://www.jianshu.com/p/37370c1d17fc",target:"_blank",rel:"noopener noreferrer"},en=u('<h2 id="前言2" tabindex="-1"><a class="header-anchor" href="#前言2" aria-hidden="true">#</a> 前言2</h2><p>源码版本：android-13.0.0_r41</p><p>结合Perfetto分析工具，基于最新Android 13 AOSP源码完整的分析一下这个从用户手指触控点击屏幕应用图标到应用界面展示到屏幕上的整个应用启动过程，也是对之前所做所学的一个总结与归纳。</p><h2 id="大纲" tabindex="-1"><a class="header-anchor" href="#大纲" aria-hidden="true">#</a> 大纲</h2><ul><li>Android 触控事件处理机制</li><li>Zygote 进程启动和应用进程创建流程</li><li>Handler 消息机制</li><li>AMS 的Activity 组件管理</li><li>应用 Application 和 Activity 组件创建与初始化</li><li>应用 UI 布局与绘制</li><li>RenderThread 渲染</li><li>SurfaceFlinger 合成显示</li></ul><h2 id="input-触控事件处理流程" tabindex="-1"><a class="header-anchor" href="#input-触控事件处理流程" aria-hidden="true">#</a> Input 触控事件处理流程</h2><h3 id="系统机制分析" tabindex="-1"><a class="header-anchor" href="#系统机制分析" aria-hidden="true">#</a> 系统机制分析</h3><p>Android 系统是由事件驱动的，而 Input 是最常见的事件之一，用户的点击、滑动、长按等操作，都属于 Input 事件驱动，其中的核心就是 <code>InputReader</code> 和 <code>InputDispatcher</code>。<code>InputReader</code> 和 <code>InputDispatcher</code> 是跑在 system_server 进程中的两个 native 循环线程，负责读取和分发 Input 事件。整个处理过程大致流程如下：</p><ul><li><code>InputReader</code> 负责从 <code>EventHub</code> 里面把 Input 事件读取出来，然后交给 <code>InputDispatcher</code> 进行事件分发；</li><li><code>InputDispatcher</code> 在拿到 <code>InputReader</code> 获取的事件之后，对事件进行包装后，寻找并分发到目标窗口;</li><li><code>InboundQueue</code> 队列（“iq”）中放着 <code>InputDispatcher</code> 从 <code>InputReader</code> 中拿到的 Input 事件；</li><li><code>OutboundQueue</code>（“oq”）队列里面放的是即将要被派发给各个目标窗口 App 的事件；</li><li><code>WaitQueue</code> 队列里面记录的是已经派发给 App（“wq”），但是 App 还在处理没有返回处理成功的事件；</li><li><code>PendingInputEventQueue</code> 队列（“aq”）中记录的是应用需要处理的 Input 事件，这里可以看到 Input 事件已经传递到了应用进程；</li><li><code>deliverInputEvent</code> 标识 App UI Thread 被 Input 事件唤醒；</li><li><code>InputResponse</code> 标识 Input 事件区域，这里可以看到一个 Input_Down 事件 + 若干个 Input_Move 事件 + 一个 Input_Up 事件的处理阶段都被算到了这里；</li><li>App 响应处理Input 事件，内部会在其界面View树中传递处理。</li></ul><p>用一张图描述整个过程大致如下：</p><p><img src="'+k+'" alt=""></p><h3 id="结合-perfetto-分析" tabindex="-1"><a class="header-anchor" href="#结合-perfetto-分析" aria-hidden="true">#</a> 结合 Perfetto 分析</h3><p>从桌面点击应用图标启动应用，system_server 的 native 线程 <code>InputReader</code> 首先负责从 <code>EventHub</code> 中利用 linux 的 epoll 机制监听并从屏幕驱动读取上报的触控事件，然后唤醒另外一条 native 线程 <code>InputDispatcher</code> 负责进行进一步事件分发。<code>InputDispatcher</code> 中会先将事件放到 <code>InboundQueue</code> 也就是“iq”队列中，然后寻找具体处理 Input 事件的目标应用窗口，并将事件放入对应的目标窗口 <code>OutboundQueue</code> 也就是“oq”队列中等待通过 <code>SocketPair</code> 双工信道发送到应用目标窗口中。最后当事件发送给具体的应用目标窗口后，会将事件移动到 <code>WaitQueue</code> 也 就是 “wq” 中等待目标应用处理事件完成，并开启倒计时，如果目标应用窗口在 5S 内没有处理完成此次触控事件，就会向 system_server 报应用 ANR 异常事件。以上整个过程在 Android 系统源码中都加有相应的 trace，如下截图所示：</p><p><img src="'+r+'" alt=""></p><p>接着上面的流程继续往下分析：当 Input 触控事件传递到桌面应用进程后，Input 事件到来后先通过 <code>enqueueInputEvent</code> 函数放入 “aq” 本地待处理队列中，并唤醒应用的 UI 线程在 <code>deliverInputEvent</code> 的流程中进行 Input 事件的具体分发与处理。</p><p>具体会先交给在应用界面 <code>Window</code> 创建时的 <code>ViewRootImpl#setView</code> 流程中创建的多个不同类型的 <code>InputStage</code> 中依次进行处理（比如对输入法处理逻辑的封装 <code>ImeInputStage</code> ），整个处理流程是按照责任链的设计模式进行。最后会交给 <code>ViewPostImeInputStage</code> 中具体进行处理，这里面会从 View 布局树的根节点 <code>DecorView</code> 开始遍历整个 <code>View</code> 树上的每一个子 <code>View</code> 或 <code>ViewGroup</code> 界面进行事件的分发、拦截、处理的逻辑。</p><p>最后触控事件处理完成后会调用 <code>finishInputEvent</code> 结束应用对触控事件处理逻辑，这里面会通过 JNI 调用到 native 层 <code>InputConsumer</code> 的 <code>sendFinishedSignal</code> 函数通知 <code>InputDispatcher</code> 事件处理完成，从触发从 &quot;wq&quot; 队列中及时移除待处理事件以免报ANR异常。</p><p><img src="'+d+'" alt=""></p><p><img src="'+v+'" alt=""></p><p>桌面应用界面 <code>View</code> 中在连续处理一个 <code>ACTION_DOWN</code> 的 <code>TouchEvent</code> 触控事件和多个 <code>ACTION_MOVE</code>，直到最后出现一个<code>ACTION_UP</code> 的 <code>TouchEvent</code> 事件后，判断属于 <code>onClick</code> 点击事件，然后透过 <code>ActivityManager</code> Binder 调用 AMS 的 <code>startActivity</code> 服务接口触发启动应用的逻辑。</p><p>从Perfetto上看如下图所示：</p><p><img src="'+m+'" alt=""><img src="'+b+`" alt=""></p><h2 id="进程的创建与启动" tabindex="-1"><a class="header-anchor" href="#进程的创建与启动" aria-hidden="true">#</a> 进程的创建与启动</h2><h3 id="pause-桌面应用" tabindex="-1"><a class="header-anchor" href="#pause-桌面应用" aria-hidden="true">#</a> Pause 桌面应用</h3><p>桌面进程收到 Input 触控事件并处理后 binder 调用框架 AMS 的的 <code>startActivity</code> 接口启动应用，相关简化代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>wm<span class="token operator">/</span><span class="token class-name">ActivityStarter</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
              <span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
              <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">Task</span> inTask<span class="token punctuation">,</span>
              <span class="token keyword">boolean</span> restrictedBgActivity<span class="token punctuation">,</span> <span class="token class-name">NeededUriGrants</span> intentGrants<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token comment">// 添加“startActivityInner”的trace tag</span>
          <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;startActivityInner&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 执行startActivityInner启动应用的逻辑</span>
          result <span class="token operator">=</span> <span class="token function">startActivityInner</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span>
                  startFlags<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> restrictedBgActivity<span class="token punctuation">,</span> intentGrants<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在执行 <code>startActivityInner</code> 启动应用逻辑中，AMS 中的 <code>Activity</code> 栈管理的逻辑，检查发现当前处于前台 Resume 状态的 <code>Activity</code> 是桌面应用，所以第一步需要通知桌面应用的 <code>Activity</code> 进入 <code>Paused</code> 状态，相关简化代码逻辑如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>wm<span class="token operator">/</span><span class="token class-name">TaskFragment</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">schedulePauseActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> prev<span class="token punctuation">,</span> <span class="token keyword">boolean</span> userLeaving<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> pauseImmediately<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoEnteringPip<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        mAtmService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                prev<span class="token punctuation">.</span>token<span class="token punctuation">,</span> <span class="token class-name">PauseActivityItem</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span>finishing<span class="token punctuation">,</span> userLeaving<span class="token punctuation">,</span>
                        prev<span class="token punctuation">.</span>configChangeFlags<span class="token punctuation">,</span> pauseImmediately<span class="token punctuation">,</span> autoEnteringPip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>桌面应用进程这边执行收到 pause 消息后执行 <code>Activity</code> 的 <code>onPause</code> 生命周期，并在执行完成后，会 binder 调用 AMS 的 <code>activityPaused</code> 接口通知系统执行完 <code>Activity</code> 的 pause 动作，相关代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>wm<span class="token operator">/</span><span class="token class-name">ActivityClientController</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">activityPaused</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;activityPaused&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r <span class="token operator">=</span> <span class="token class-name">ActivityRecord</span><span class="token punctuation">.</span><span class="token function">forTokenLocked</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">activityPaused</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>wm<span class="token operator">/</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">activityPaused</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">final</span> <span class="token class-name">TaskFragment</span> taskFragment <span class="token operator">=</span> <span class="token function">getTaskFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>taskFragment <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removePauseTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> pausingActivity <span class="token operator">=</span> taskFragment<span class="token punctuation">.</span><span class="token function">getPausingActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pausingActivity <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mAtmService<span class="token punctuation">.</span><span class="token function">deferWindowLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              taskFragment<span class="token punctuation">.</span><span class="token function">completePause</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment">/* resumeNext */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* resumingActivity */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在Perfetto中表现为：</p><p><img src="`+y+'" alt=""></p><p><img src="'+t+'" alt=""></p><p>具体的调用链路如下图所示：</p><p><img src="'+w+'" alt=""></p><p><img src="'+f+`" alt=""></p><p>AMS 这边收到应用的 <code>activityPaused</code> 调用后，继续执行启动应用的逻辑，判断需要启动的应用 <code>Activity</code> 所在的进程不存在，所以接下来需要先 <code>startProcessAsync</code> 创建应用进程，相关简化代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>wm<span class="token operator">/</span><span class="token class-name">ActivityTaskSupervisor</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">startSpecificActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Is this activity&#39;s application already running?</span>
    <span class="token keyword">final</span> <span class="token class-name">WindowProcessController</span> wpc <span class="token operator">=</span>
            mService<span class="token punctuation">.</span><span class="token function">getProcessController</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> knownToBeDead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wpc <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> wpc<span class="token punctuation">.</span><span class="token function">hasThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> wpc<span class="token punctuation">,</span> andResume<span class="token punctuation">,</span> checkConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    mService<span class="token punctuation">.</span><span class="token function">startProcessAsync</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> isTop<span class="token punctuation">,</span>
            isTop <span class="token operator">?</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">.</span><span class="token constant">HOSTING_TYPE_TOP_ACTIVITY</span>
                    <span class="token operator">:</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">.</span><span class="token constant">HOSTING_TYPE_ACTIVITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+g+'" alt=""></p><p><img src="'+h+'" alt=""></p><p><img src="'+A+'" alt=""></p><h3 id="创建应用进程" tabindex="-1"><a class="header-anchor" href="#创建应用进程" aria-hidden="true">#</a> 创建应用进程</h3><p>接上一小节的分析可以知道，Android 应用进程的启动是被动式的，在桌面点击图标启动一个应用的组件如 Activity 时，如果 Activity 所在的进程不存在，就会创建并启动进程。Android 系统中一般应用进程的创建都是统一由 zygote 进程 fork 创建的，AMS 在需要创建应用进程时，会通过 socket 连接并通知到到 zygote 进程在开机阶段就创建好的 socket 服务端，然后由 zygote 进程 fork 创建出应用进程。整体架构如下图所示：</p><p><img src="'+t+'" alt=""><img src="'+T+'" alt=""><img src="'+I+'" alt=""><img src="'+S+'" alt=""><img src="'+R+'" alt=""><img src="'+C+'" alt=""><img src="'+_+`" alt=""></p><p>我们接着上节中的分析，继续从 <code>AMS#startProcessAsync</code> 创建进程函数入手，继续看一下应用进程创建相关简化流程代码：</p><h4 id="ams-发送-socket-请求" tabindex="-1"><a class="header-anchor" href="#ams-发送-socket-请求" aria-hidden="true">#</a> AMS 发送 socket 请求</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>wm<span class="token operator">/</span><span class="token class-name">ActivityTaskManagerService</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">startProcessAsync</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> activity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isTop<span class="token punctuation">,</span>
        <span class="token class-name">String</span> hostingType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;dispatchingStartProcess:&quot;</span>
                    <span class="token operator">+</span> activity<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Post message to start process to avoid possible deadlock of calling into AMS with the</span>
        <span class="token comment">// ATMS lock held.</span>
        <span class="token keyword">final</span> <span class="token class-name">Message</span> m <span class="token operator">=</span> <span class="token class-name">PooledLambda</span><span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span><span class="token class-name">ActivityManagerInternal</span><span class="token operator">::</span><span class="token function">startProcess</span><span class="token punctuation">,</span>
                mAmInternal<span class="token punctuation">,</span> activity<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> activity<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span>
                isTop<span class="token punctuation">,</span> hostingType<span class="token punctuation">,</span> activity<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mH<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>am<span class="token operator">/</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startProcess</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span> <span class="token class-name">ApplicationInfo</span> info<span class="token punctuation">,</span> <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> isTop<span class="token punctuation">,</span> <span class="token class-name">String</span> hostingType<span class="token punctuation">,</span> <span class="token class-name">ComponentName</span> hostingName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;startProcess:&quot;</span>
                    <span class="token operator">+</span> processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If the process is known as top app, set a hint so when the process is</span>
            <span class="token comment">// started, the top priority can be applied immediately to avoid cpu being</span>
            <span class="token comment">// preempted by other processes before attaching the process of top app.</span>
            <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> info<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* intentFlags */</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">(</span>hostingType<span class="token punctuation">,</span> hostingName<span class="token punctuation">,</span> isTop<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token constant">ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* allowWhileBooting */</span><span class="token punctuation">,</span>
                    <span class="token boolean">false</span> <span class="token comment">/* isolated */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>am<span class="token operator">/</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span>java
<span class="token keyword">final</span> <span class="token class-name">ProcessRecord</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span>
        <span class="token class-name">ApplicationInfo</span> info<span class="token punctuation">,</span> <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">int</span> intentFlags<span class="token punctuation">,</span>
        <span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowWhileBooting<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> isolated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mProcessList<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> info<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> intentFlags<span class="token punctuation">,</span>
            hostingRecord<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span> allowWhileBooting<span class="token punctuation">,</span> isolated<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* isolatedUid */</span><span class="token punctuation">,</span>
            <span class="token boolean">false</span> <span class="token comment">/* isSdkSandbox */</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* sdkSandboxClientAppUid */</span><span class="token punctuation">,</span>
            <span class="token keyword">null</span> <span class="token comment">/* sdkSandboxClientAppPackage */</span><span class="token punctuation">,</span>
            <span class="token keyword">null</span> <span class="token comment">/* ABI override */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* entryPoint */</span><span class="token punctuation">,</span>
            <span class="token keyword">null</span> <span class="token comment">/* entryPointArgs */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* crashHandler */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>am<span class="token operator">/</span><span class="token class-name">ProcessList</span><span class="token punctuation">.</span>java
<span class="token keyword">boolean</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span><span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span> <span class="token class-name">String</span> entryPoint<span class="token punctuation">,</span> <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span>
        <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span> <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span>
        <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span> <span class="token class-name">String</span> requiredAbi<span class="token punctuation">,</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span> <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span>
        <span class="token keyword">long</span> startUptime<span class="token punctuation">,</span> <span class="token keyword">long</span> startElapsedTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mConstants<span class="token punctuation">.</span><span class="token constant">FLAG_PROCESS_START_ASYNC</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_PROCESSES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG_PROCESSES</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Posting procStart msg for &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span>mProcStartHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">handleProcessStart</span><span class="token punctuation">(</span>
                app<span class="token punctuation">,</span> entryPoint<span class="token punctuation">,</span> gids<span class="token punctuation">,</span> runtimeFlags<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span>
                requiredAbi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>am<span class="token operator">/</span><span class="token class-name">ProcessList</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleProcessStart</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> entryPoint<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> requiredAbi<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Runnable</span> startRunnable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> startResult <span class="token operator">=</span> <span class="token function">startProcess</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getHostingRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    entryPoint<span class="token punctuation">,</span> app<span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">getStartUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gids<span class="token punctuation">,</span> runtimeFlags<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span>
                    mountExternal<span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">getSeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requiredAbi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">handleProcessStartedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> startResult<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>am<span class="token operator">/</span><span class="token class-name">ProcessList</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">startProcess</span><span class="token punctuation">(</span><span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span> <span class="token class-name">String</span> entryPoint<span class="token punctuation">,</span>
        <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span> <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span>
        <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span> <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span> <span class="token class-name">String</span> requiredAbi<span class="token punctuation">,</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span>
        <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span> <span class="token keyword">long</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;Start proc: &quot;</span> <span class="token operator">+</span>
                app<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> startResult<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> regularZygote <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hostingRecord<span class="token punctuation">.</span><span class="token function">usesWebviewZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hostingRecord<span class="token punctuation">.</span><span class="token function">usesAppZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            regularZygote <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            startResult <span class="token operator">=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span> runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span> requiredAbi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dataDir<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span>
                    isTopApp<span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">getDisabledCompatChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pkgDataInfoMap<span class="token punctuation">,</span>
                    allowlistedAppDataInfoMap<span class="token punctuation">,</span> bindMountAppsData<span class="token punctuation">,</span> bindMountAppStorageDirs<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token constant">PROC_START_SEQ_IDENT</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">getStartSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">return</span> startResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">Process</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ProcessStartResult</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> <span class="token class-name">String</span> processClass<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">String</span> niceName<span class="token punctuation">,</span>
                                        <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> gid<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span>
                                        <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span>
                                        <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span>
                                        <span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> abi<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> appDataDir<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> packageName<span class="token punctuation">,</span>
                                        <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span>
                                        <span class="token keyword">boolean</span> isTopApp<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                pkgDataInfoMap<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                whitelistedDataInfoMap<span class="token punctuation">,</span>
                                        <span class="token keyword">boolean</span> bindMountAppsData<span class="token punctuation">,</span>
                                        <span class="token keyword">boolean</span> bindMountAppStorageDirs<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> zygoteArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">ZYGOTE_PROCESS</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>processClass<span class="token punctuation">,</span> niceName<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span>
                runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span> targetSdkVersion<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span>
                abi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span> appDataDir<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> packageName<span class="token punctuation">,</span>
                zygotePolicyFlags<span class="token punctuation">,</span> isTopApp<span class="token punctuation">,</span> disabledCompatChanges<span class="token punctuation">,</span>
                pkgDataInfoMap<span class="token punctuation">,</span> whitelistedDataInfoMap<span class="token punctuation">,</span> bindMountAppsData<span class="token punctuation">,</span>
                bindMountAppStorageDirs<span class="token punctuation">,</span> zygoteArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ZygoteProcess</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> <span class="token class-name">String</span> processClass<span class="token punctuation">,</span>
                                                <span class="token keyword">final</span> <span class="token class-name">String</span> niceName<span class="token punctuation">,</span>
                                                <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> gid<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span>
                                                <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span>
                                                <span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> abi<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> appDataDir<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> packageName<span class="token punctuation">,</span>
                                                <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span>
                                                <span class="token keyword">boolean</span> isTopApp<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                        pkgDataInfoMap<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                        allowlistedDataInfoList<span class="token punctuation">,</span>
                                                <span class="token keyword">boolean</span> bindMountAppsData<span class="token punctuation">,</span>
                                                <span class="token keyword">boolean</span> bindMountAppStorageDirs<span class="token punctuation">,</span>
                                                <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> zygoteArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">startViaZygote</span><span class="token punctuation">(</span>processClass<span class="token punctuation">,</span> niceName<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> gid<span class="token punctuation">,</span> gids<span class="token punctuation">,</span>
                runtimeFlags<span class="token punctuation">,</span> mountExternal<span class="token punctuation">,</span> targetSdkVersion<span class="token punctuation">,</span> seInfo<span class="token punctuation">,</span>
                abi<span class="token punctuation">,</span> instructionSet<span class="token punctuation">,</span> appDataDir<span class="token punctuation">,</span> invokeWith<span class="token punctuation">,</span> <span class="token comment">/*startChildZygote=*/</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                packageName<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span> isTopApp<span class="token punctuation">,</span> disabledCompatChanges<span class="token punctuation">,</span>
                pkgDataInfoMap<span class="token punctuation">,</span> allowlistedDataInfoList<span class="token punctuation">,</span> bindMountAppsData<span class="token punctuation">,</span>
                bindMountAppStorageDirs<span class="token punctuation">,</span> zygoteArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ZygoteStartFailedEx</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ZygoteProcess</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">startViaZygote</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> <span class="token class-name">String</span> processClass<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">String</span> niceName<span class="token punctuation">,</span>
                                                    <span class="token keyword">final</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> gid<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span>
                                                    <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span>
                                                    <span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> abi<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> appDataDir<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span>
                                                    <span class="token keyword">boolean</span> startChildZygote<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> packageName<span class="token punctuation">,</span>
                                                    <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span>
                                                    <span class="token keyword">boolean</span> isTopApp<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                            pkgDataInfoMap<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                            allowlistedDataInfoList<span class="token punctuation">,</span>
                                                    <span class="token keyword">boolean</span> bindMountAppsData<span class="token punctuation">,</span>
                                                    <span class="token keyword">boolean</span> bindMountAppStorageDirs<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> extraArgs<span class="token punctuation">)</span>
                                                    <span class="token keyword">throws</span> <span class="token class-name">ZygoteStartFailedEx</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token function">zygoteSendArgsAndGetResult</span><span class="token punctuation">(</span><span class="token function">openZygoteSocketIfNeeded</span><span class="token punctuation">(</span>abi<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            zygotePolicyFlags<span class="token punctuation">,</span>
                                            argsForZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">zygoteSendArgsAndGetResult</span><span class="token punctuation">(</span>
        <span class="token class-name">ZygoteState</span> zygoteState<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ZygoteStartFailedEx</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">/*
        * See com.android.internal.os.ZygoteArguments.parseArgs()
        * Presently the wire format to the zygote process is:
        * a) a count of arguments (argc, in essence)
        * b) a number of newline-separated argument strings equal to count
        *
        * After the zygote process reads these it will write the pid of
        * the child or -1 on failure, followed by boolean to
        * indicate whether a wrapper process was used.
        */</span>
    <span class="token class-name">String</span> msgStr <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\\n&quot;</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldAttemptUsapLaunch</span><span class="token punctuation">(</span>zygotePolicyFlags<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">attemptUsapSendArgsAndGetResult</span><span class="token punctuation">(</span>zygoteState<span class="token punctuation">,</span> msgStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If there was an IOException using the USAP pool we will log the error and</span>
            <span class="token comment">// attempt to start the process through the Zygote.</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">LOG_TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;IO Exception while communicating with USAP pool - &quot;</span>
                    <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">attemptZygoteSendArgsAndGetResult</span><span class="token punctuation">(</span>zygoteState<span class="token punctuation">,</span> msgStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">attemptZygoteSendArgsAndGetResult</span><span class="token punctuation">(</span>
        <span class="token class-name">ZygoteState</span> zygoteState<span class="token punctuation">,</span> <span class="token class-name">String</span> msgStr<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZygoteStartFailedEx</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">BufferedWriter</span> zygoteWriter <span class="token operator">=</span> zygoteState<span class="token punctuation">.</span>mZygoteOutputWriter<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">DataInputStream</span> zygoteInputStream <span class="token operator">=</span> zygoteState<span class="token punctuation">.</span>mZygoteInputStream<span class="token punctuation">;</span>

        zygoteWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msgStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        zygoteWriter<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Always read the entire result from the input stream to avoid leaving</span>
        <span class="token comment">// bytes in the stream for future process starts to accidentally stumble</span>
        <span class="token comment">// upon.</span>
        <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>pid <span class="token operator">=</span> zygoteInputStream<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>usingWrapper <span class="token operator">=</span> zygoteInputStream<span class="token punctuation">.</span><span class="token function">readBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteStartFailedEx</span><span class="token punctuation">(</span><span class="token string">&quot;fork() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        zygoteState<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">LOG_TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;IO Exception while communicating with Zygote - &quot;</span>
                <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteStartFailedEx</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>msgStr:
--runtime-args
--setuid=10116
--setgid=10116
--runtime-flags=16787715
--mount-external-default
--target-sdk-version=33
--setgroups=50116,20116,9997
--nice-name=com.example.myapplication
--seinfo=default:targetSdkVersion=33:complete
--app-data-dir=/data/user/0/com.example.myapplication
--package-name=com.example.myapplication
--is-top-app
--pkg-data-info-map=com.example.myapplication,null,123338
--bind-mount-data-dirs
--disabled-compat-changes=132649864,135634846,135772972,143231523,143539591,161145287,162547999,166236554,168419799,169897160,170233598,174042936,174042980,174043039,174227820,174228127,176926741,176926753,176926771,176926829,177438394,178038272,180326787,180326845,181136395,182811243,184838306,185004937,189229956,189969734,189969744,189969749,189969779,189969782,189970036,189970038,189970040,191513214,196254758,208648326,210856463,218959984,226439802,254631730,263259275
android.app.ActivityThread
seq=54

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>ZygoteProcess#startViaZygote</code> 中，最后创建应用进程的逻辑：</p><p><code>openZygoteSocketIfNeeded</code> 函数中打开本地 socket 客户端连接到 zygote 进程的 socket 服务端； <code>zygoteSendArgsAndGetResult</code> 发送 socket 请求参数，带上了创建的应用进程参数信息； return 返回的数据结构 <code>ProcessStartResult</code> 中会有新创建的进程的pid字段。</p><h3 id="zygote-处理-socket-请求" tabindex="-1"><a class="header-anchor" href="#zygote-处理-socket-请求" aria-hidden="true">#</a> Zygote 处理 socket 请求</h3><p>其实早在系统开机阶段，zygote 进程创建时，就会在 <code>ZygoteInit#main</code> 入口函数中创建服务端 socket，并预加载系统资源和框架类（加速应用进程启动速度），代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ZygoteServer</span> zygoteServer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enableLazyPreload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.preload提前加载框架通用类和系统资源到进程，加速进程启动</span>
            <span class="token function">preload</span><span class="token punctuation">(</span>bootTimingsTraceLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2.创建zygote进程的socket server服务端对象</span>
        zygoteServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteServer</span><span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Accepting command socket connections&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.进入死循环，等待AMS发请求过来</span>
        caller <span class="token operator">=</span> zygoteServer<span class="token punctuation">.</span><span class="token function">runSelectLoop</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>继续往下看 <code>ZygoteServer#runSelectLoop</code> 如何监听并处理AMS客户端的请求：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ZygoteServer</span><span class="token punctuation">.</span>java
<span class="token class-name">Runnable</span> <span class="token function">runSelectLoop</span><span class="token punctuation">(</span><span class="token class-name">String</span> abiList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 进入死循环监听</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>pollIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pollIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pollIndex <span class="token operator">&lt;</span> usapPoolEventFDIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Session socket accepted from the Zygote server socket</span>
            <span class="token comment">// 得到一个请求连接封装对象ZygoteConnection</span>
            <span class="token class-name">ZygoteConnection</span> connection <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pollIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// processCommand函数中处理AMS客户端请求</span>
            <span class="token keyword">final</span> <span class="token class-name">Runnable</span> command <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">processCommand</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> multipleForksOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ZygoteConnection</span><span class="token punctuation">.</span>java
<span class="token class-name">Runnable</span> <span class="token function">processCommand</span><span class="token punctuation">(</span><span class="token class-name">ZygoteServer</span> zygoteServer<span class="token punctuation">,</span> <span class="token keyword">boolean</span> multipleOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 1.fork创建应用子进程</span>
        pid <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">forkAndSpecialize</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">// 2.pid为0，当前处于新创建的子应用进程中，处理请求参数</span>
                <span class="token keyword">return</span> <span class="token function">handleChildProc</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">,</span> childPipeFd<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mStartChildZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token function">handleParentProc</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> serverPipeFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ZygoteConnection</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token class-name">Runnable</span> <span class="token function">handleChildProc</span><span class="token punctuation">(</span><span class="token class-name">ZygoteArguments</span> parsedArgs<span class="token punctuation">,</span>
        <span class="token class-name">FileDescriptor</span> pipeFd<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isZygote<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 关闭从父进程zygote继承过来的ZygoteServer服务端地址</span>
    <span class="token function">closeSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mInvokeWith <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isZygote<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 继续进入ZygoteInit#zygoteInit继续完成子应用进程的相关初始化工作</span>
            <span class="token keyword">return</span> <span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span><span class="token function">zygoteInit</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mTargetSdkVersion<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mDisabledCompatChanges<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mRemainingArgs<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* classLoader */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="应用进程初始化" tabindex="-1"><a class="header-anchor" href="#应用进程初始化" aria-hidden="true">#</a> 应用进程初始化</h3><p><img src="`+L+`" alt=""></p><p>接上一节中的分析，zygote 进程监听接收 AMS 的请求，fork 创建子应用进程，然后pid为0时进入子进程空间，然后在 <code>ZygoteInit#zygoteInit</code> 中完成进程的初始化动作，相关简化代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">/*frameworks/base/core/java/com/android/internal/os/ZygoteInit.java*/</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">zygoteInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 原生添加名为“ZygoteInit ”的systrace tag以标识进程初始化流程</span>
    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;ZygoteInit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">redirectLogStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.RuntimeInit#commonInit中设置应用进程默认的java异常处理机制</span>
    <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">commonInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.ZygoteInit#nativeZygoteInit函数中JNI调用启动进程的binder线程池</span>
    <span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span><span class="token function">nativeZygoteInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.RuntimeInit#applicationInit中反射创建ActivityThread对象并调用其“main”入口方法</span>
    <span class="token keyword">return</span> <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">applicationInit</span><span class="token punctuation">(</span>targetSdkVersion<span class="token punctuation">,</span> disabledCompatChanges<span class="token punctuation">,</span> argv<span class="token punctuation">,</span>
            classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>应用进程启动后，初始化过程中主要依次完成以下几件事情：</p><ul><li>应用进程默认的 java 异常处理机制（可以实现监听、拦截应用进程所有的Java crash的逻辑）；</li><li>JNI调用启动进程的 binder 线程池（注意应用进程的binder线程池资源是自己创建的并非从 zygote 父进程继承的）；</li><li>通过反射创建 <code>ActivityThread</code> 对象并调用其 <code>main</code> 入口方法。</li></ul><p>我们继续看 <code>RuntimeInit#applicationInit</code> 简化的代码流程：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span>java
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">applicationInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 结束“ZygoteInit ”的systrace tag</span>
    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Remaining arguments are passed to the start class&#39;s static main</span>
    <span class="token keyword">return</span> <span class="token function">findStaticMain</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>startClass<span class="token punctuation">,</span> args<span class="token punctuation">.</span>startArgs<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span>java
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">findStaticMain</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span>
        <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cl<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.反射加载创建ActivityThread类对象</span>
        cl <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Method</span> m<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.反射调用其main方法</span>
        m <span class="token operator">=</span> cl<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 3.触发执行以上逻辑</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们继续往下看 <code>ActivityThread</code> 的 <code>main</code> 函数中又干了什么：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 原生添加的标识进程ActivityThread初始化过程的systrace tag，名为“ActivityThreadMain”</span>
     <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;ActivityThreadMain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token comment">// 1.创建并启动主线程的loop消息循环</span>
     <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token comment">// 2.attachApplication注册到系统AMS中</span>
     <span class="token class-name">ActivityThread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     thread<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> system<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>system<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token keyword">final</span> <span class="token class-name">IActivityManager</span> mgr <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 通过binder调用AMS的attachApplication接口将自己注册到AMS中</span>
          mgr<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到进程 <code>ActivityThread#main</code> 函数初始化的主要逻辑是：</p><ul><li>创建并启动主线程的loop消息循环；</li><li>通过 binder 调用 AMS 的 <code>attachApplication</code> 接口将自己 attach 注册到 AMS 中。</li></ul><p><img src="`+P+'" alt=""></p><p><img src="'+N+`" alt=""></p><h2 id="主线程消息循环机制的建立" tabindex="-1"><a class="header-anchor" href="#主线程消息循环机制的建立" aria-hidden="true">#</a> 主线程消息循环机制的建立</h2><p>接上一节的分析，我们知道应用进程创建后会通过反射创建 <code>ActivityThread</code> 对象并执行其 <code>main</code> 函数，进行主线程的初始化工作：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token comment">// 1.创建Looper、MessageQueue</span>
     <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token comment">// 2.启动loop消息循环，开始准备接收消息</span>
     <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// 3.创建主线程Handler对象</span>
frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span>
        <span class="token keyword">implements</span> <span class="token class-name">ActivityThreadInternal</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
    <span class="token keyword">final</span> <span class="token class-name">Looper</span> mLooper <span class="token operator">=</span> <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">H</span> mH <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">H</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">class</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">BIND_APPLICATION</span>        <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">EXIT_APPLICATION</span>        <span class="token operator">=</span> <span class="token number">111</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RECEIVER</span>                <span class="token operator">=</span> <span class="token number">113</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CREATE_SERVICE</span>          <span class="token operator">=</span> <span class="token number">114</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">Looper</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     
     <span class="token comment">// 准备主线程的Looper</span>
     <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">// </span>
     <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainLooper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;The main Looper has already been prepared.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          sMainLooper <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">Looper</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Only one Looper may be created per thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 创建主线程的Looper对象，并通过ThreadLocal机制实现与主线程的一对一绑定</span>
      sThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">Looper</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建MessageQueue消息队列</span>
      mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主线程初始化完成后，主线程就有了完整的 <code>Looper</code>、<code>MessageQueue</code>、<code>Handler</code>，此时 <code>ActivityThread</code> 的 <code>Handler</code> 就可以开始处理 <code>Message</code>，包括 <code>Application</code>、<code>Activity</code>、<code>ContentProvider</code>、<code>Service</code>、<code>Broadcast</code> 等组件的生命周期函数，都会以 <code>Message</code> 的形式，在主线程按照顺序处理，这就是 App 主线程的初始化和运行原理，部分处理的 Message 如下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">class</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">BIND_APPLICATION</span>        <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RECEIVER</span>                <span class="token operator">=</span> <span class="token number">113</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CREATE_SERVICE</span>          <span class="token operator">=</span> <span class="token number">114</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">BIND_SERVICE</span>            <span class="token operator">=</span> <span class="token number">121</span><span class="token punctuation">;</span>
        
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">BIND_APPLICATION</span><span class="token operator">:</span>
                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;bindApplication&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">AppBindData</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AppBindData</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                    <span class="token function">handleBindApplication</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主线程初始化完成后，主线程就进入阻塞状态，等待 <code>Message</code>，一旦有 <code>Message</code> 发过来，主线程就会被唤醒，处理 <code>Message</code>，处理完成之后，如果没有其他的 <code>Message</code> 需要处理，那么主线程就会进入休眠阻塞状态继续等待。可以说 Android 系统的运行是受消息机制驱动的，而整个消息机制是由上面所说的四个关键角色相互配合实现的（<code>Handler</code>、<code>Looper</code>、<code>MessageQueue</code>、<code>Message</code>），其运行原理如下图所示：</p><p><img src="`+E+`" alt=""></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">Looper</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Looper</span> me <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">loopOnce</span><span class="token punctuation">(</span>me<span class="token punctuation">,</span> ident<span class="token punctuation">,</span> thresholdOverride<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">Looper</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">loopOnce</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Looper</span> me<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> ident<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> thresholdOverride<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//</span>
    <span class="token class-name">Message</span> msg <span class="token operator">=</span> me<span class="token punctuation">.</span>mQueue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// might block</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">MessageQueue</span><span class="token punctuation">.</span>java
<span class="token class-name">Message</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>jni<span class="token operator">/</span>android_os_MessageQueue<span class="token punctuation">.</span>cpp
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">android_os_MessageQueue_nativePollOnce</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span><span class="token operator">*</span> env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">,</span>
        jlong ptr<span class="token punctuation">,</span> jint timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    nativeMessageQueue<span class="token operator">-&gt;</span><span class="token function">pollOnce</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>jni<span class="token operator">/</span>android_os_MessageQueue<span class="token punctuation">.</span>cpp
<span class="token keyword">void</span> <span class="token class-name">NativeMessageQueue</span><span class="token operator">::</span><span class="token function">pollOnce</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span><span class="token operator">*</span> env<span class="token punctuation">,</span> jobject pollObj<span class="token punctuation">,</span> <span class="token keyword">int</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mLooper<span class="token operator">-&gt;</span><span class="token function">pollOnce</span><span class="token punctuation">(</span>timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

 <span class="token doc-comment comment">/**
 * Waits for events to be available, with optional timeout in milliseconds.
 * Invokes callbacks for all file descriptors on which an event occurred.
 */</span>
<span class="token keyword">int</span> <span class="token function">pollOnce</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeoutMillis<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> outFd<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> outEvents<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> outData<span class="token punctuation">)</span><span class="token punctuation">;</span>
inline <span class="token keyword">int</span> <span class="token function">pollOnce</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">pollOnce</span><span class="token punctuation">(</span>timeoutMillis<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// system/core/libutils/Looper.cpp</span>
<span class="token keyword">int</span> <span class="token class-name">Looper</span><span class="token operator">::</span><span class="token function">pollOnce</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeoutMillis<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> outFd<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> outEvents<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> outData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        result <span class="token operator">=</span> <span class="token function">pollInner</span><span class="token punctuation">(</span>timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// system/core/libutils/Looper.cpp</span>
<span class="token keyword">int</span> <span class="token class-name">Looper</span><span class="token operator">::</span><span class="token function">pollInner</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">int</span> eventCount <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>mEpollFd<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> eventItems<span class="token punctuation">,</span> <span class="token constant">EPOLL_MAX_EVENTS</span><span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>Handler</code> : <code>Handler</code> 主要是用来处理 <code>Message</code>，应用可以在任何线程创建 <code>Handler</code>，只要在创建的时候指定对应的 <code>Looper</code> 即可，如果不指定，默认是在当前 <code>Thread</code> 对应的 <code>Looper</code>。</li><li><code>Looper</code>: <code>Looper</code> 可以看成是一个循环器，其 <code>loop</code> 方法开启后，不断地从 <code>MessageQueue</code> 中获取 <code>Message</code>，对 <code>Message</code> 进行 <code>Delivery</code> 和 <code>Dispatch</code>，最终发给对应的 <code>Handler</code> 去处理。</li><li><code>MessageQueue</code>：<code>MessageQueue</code> 就是一个 <code>Message</code> 管理器，队列中是 <code>Message</code>，在没有 <code>Message</code> 的时候，<code>MessageQueue</code> 借助 Linux 的 ePoll 机制，阻塞休眠等待，直到有 <code>Message</code> 进入队列将其唤醒。</li><li><code>Message</code>：<code>Message</code> 是传递消息的对象，其内部包含了要传递的内容，最常用的包括 what、arg、callback 等。</li></ul><h2 id="application-和-activity-组件创建与初始化" tabindex="-1"><a class="header-anchor" href="#application-和-activity-组件创建与初始化" aria-hidden="true">#</a> Application 和 Activity 组件创建与初始化</h2><h3 id="application-的创建与初始化" tabindex="-1"><a class="header-anchor" href="#application-的创建与初始化" aria-hidden="true">#</a> Application 的创建与初始化</h3><p>应用进程启动初始化执行 <code>ActivityThread#main</code> 函数过程中，在开启主线程 <code>loop</code> 消息循环之前，会通过 Binder 调用系统核心服务 AMS 的 <code>attachApplication</code> 接口将自己注册到 AMS 中。下面我们接着这个流程往下看，我们先从Perfetto上看看 AMS 服务的 <code>attachApplication</code> 接口是如何处理应用进程的 attach 注册请求的：</p><p><img src="`+V+'" alt=""></p><p><img src="'+j+`" alt=""></p><p>我们继续来看相关代码的简化流程：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>am<span class="token operator">/</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> thread<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>am<span class="token operator">/</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IApplicationThread</span> thread<span class="token punctuation">,</span>
            <span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>isolatedEntryPoint <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instr2 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            thread<span class="token punctuation">.</span><span class="token function">bindApplication</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>sdkSandboxClientAppVolumeUuid<span class="token punctuation">,</span> app<span class="token punctuation">.</span>sdkSandboxClientAppPackage<span class="token punctuation">,</span>
                    providerList<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> testMode<span class="token punctuation">,</span>
                    mBinderTransactionTrackingEnabled<span class="token punctuation">,</span> enableTrackAllocation<span class="token punctuation">,</span>
                    isRestrictedBackupMode <span class="token operator">||</span> <span class="token operator">!</span>normalMode<span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">isPersistent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span><span class="token function">getCompat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getCommonServicesLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>isolated<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mCoreSettingsObserver<span class="token punctuation">.</span><span class="token function">getCoreSettingsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    buildSerial<span class="token punctuation">,</span> autofillOptions<span class="token punctuation">,</span> contentCaptureOptions<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span><span class="token function">getDisabledCompatChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serializedSystemFontMap<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span><span class="token function">getStartElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">getStartUptime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token comment">// See if the top visible activity is waiting to run in this process...</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>normalMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            didSomething <span class="token operator">=</span> mAtmInternal<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationThread</span> <span class="token keyword">extends</span> <span class="token class-name">IApplicationThread<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{</span>
       <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bindApplication</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span> <span class="token class-name">ApplicationInfo</span> appInfo<span class="token punctuation">,</span>
                <span class="token class-name">String</span> sdkSandboxClientAppVolumeUuid<span class="token punctuation">,</span> <span class="token class-name">String</span> sdkSandboxClientAppPackage<span class="token punctuation">,</span>
                <span class="token class-name">ProviderInfoList</span> providerList<span class="token punctuation">,</span> <span class="token class-name">ComponentName</span> instrumentationName<span class="token punctuation">,</span>
                <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> instrumentationArgs<span class="token punctuation">,</span>
                <span class="token class-name">IInstrumentationWatcher</span> instrumentationWatcher<span class="token punctuation">,</span>
                <span class="token class-name">IUiAutomationConnection</span> instrumentationUiConnection<span class="token punctuation">,</span> <span class="token keyword">int</span> debugMode<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> enableBinderTracking<span class="token punctuation">,</span> <span class="token keyword">boolean</span> trackAllocation<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> isRestrictedBackupMode<span class="token punctuation">,</span> <span class="token keyword">boolean</span> persistent<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> config<span class="token punctuation">,</span>
                <span class="token class-name">CompatibilityInfo</span> compatInfo<span class="token punctuation">,</span> <span class="token class-name">Map</span> services<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> coreSettings<span class="token punctuation">,</span>
                <span class="token class-name">String</span> buildSerial<span class="token punctuation">,</span> <span class="token class-name">AutofillOptions</span> autofillOptions<span class="token punctuation">,</span>
                <span class="token class-name">ContentCaptureOptions</span> contentCaptureOptions<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
                <span class="token class-name">SharedMemory</span> serializedSystemFontMap<span class="token punctuation">,</span>
                <span class="token keyword">long</span> startRequestedElapsedTime<span class="token punctuation">,</span> <span class="token keyword">long</span> startRequestedUptime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token class-name">AppBindData</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppBindData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>processName <span class="token operator">=</span> processName<span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>appInfo <span class="token operator">=</span> appInfo<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">.</span><span class="token constant">BIND_APPLICATION</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">class</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">BIND_APPLICATION</span><span class="token operator">:</span>
                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;bindApplication&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">AppBindData</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AppBindData</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                    <span class="token comment">// 在应用主线程执行handleBindApplication初始化动作</span>
                    <span class="token function">handleBindApplication</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
           <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleBindApplication</span><span class="token punctuation">(</span><span class="token class-name">AppBindData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上面的代码流程可以看出：AMS 服务在执行应用的 <code>attachApplication</code> 注册请求过程中，会用应用进程<code>ActivityThread#IApplicationThread</code> 的 <code>bindApplication</code> 接口，而 <code>bindApplication</code> 接口函数实现中又会通过往应用主线程消息队列 post <code>BIND_APPLICATION</code> 消息触发执行<code>handleBindApplication</code> 初始化函数，从 Perfetto 看如下图所示：</p><p><img src="`+D+`" alt=""></p><p>我们继续结合代码看看 <code>handleBindApplication</code> 的简化关键流程：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleBindApplication</span><span class="token punctuation">(</span><span class="token class-name">AppBindData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// 1.创建应用的LoadedApk对象</span>
    data<span class="token punctuation">.</span>info <span class="token operator">=</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// 2.创建应用Application的Context、触发Art虚拟机加载应用APK的Dex文件到内存中，并加载应用APK的Resource资源</span>
    <span class="token keyword">final</span> <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// 3.调用LoadedApk的makeApplication函数，实现创建应用的Application对象</span>
    <span class="token comment">// If the app is being launched for full backup or restore, bring it up in</span>
    <span class="token comment">// a restricted environment with the base application class.</span>
    app <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">makeApplicationInner</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 4.执行应用Application#onCreate生命周期函数</span>
    <span class="token comment">// Do this after providers, since instrumentation tests generally start their</span>
    <span class="token comment">// test thread at this point, and we don&#39;t want that racing.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;Exception thrown in onCreate() of &quot;</span>
            <span class="token operator">+</span> data<span class="token punctuation">.</span>instrumentationName <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>ActivityThread#handleBindApplication</code> 初始化过程中在应用主线程中主要完成如下几件事件**：</p><ul><li>根据框架传入的 <code>ApplicationInfo</code> 息创建应用 APK 对应的 <code>LoadedApk</code> 对象;</li><li>创建应用 <code>Application</code> 的 <code>Context</code> 对象；</li><li>创建类加载器 <code>ClassLoader</code> 对象并触发 Art 虚拟机执行 <code>OpenDexFilesFromOat</code> 动作加载应用 APK 的 Dex 文件；</li><li>通过 <code>LoadedApk</code> 加载应用 APK 的 Resource 资源；</li><li>调用 <code>LoadedApk</code> 的 <code>makeApplication</code> 函数，创建应用的 <code>Application</code> 对象;</li><li>执行应用 <code>Application#onCreate</code> 生命周期函数（APP应用开发者能控制的第一行代码）;</li></ul><h3 id="应用apk的dex文件加载" tabindex="-1"><a class="header-anchor" href="#应用apk的dex文件加载" aria-hidden="true">#</a> 应用APK的Dex文件加载</h3><p>下面我们结合代码重点看看 APK Dex 文件的加载和 Resource 资源的加载流程。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ContextImpl</span><span class="token punctuation">.</span>java
<span class="token keyword">static</span> <span class="token class-name">ContextImpl</span> <span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token class-name">ActivityThread</span> mainThread<span class="token punctuation">,</span> <span class="token class-name">LoadedApk</span> packageInfo<span class="token punctuation">,</span>
            <span class="token class-name">String</span> opPackageName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>packageInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;packageInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.创建应用Application的Context对象</span>
    <span class="token class-name">ContextImpl</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> mainThread<span class="token punctuation">,</span> packageInfo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> opPackageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.触发加载APK的DEX文件和Resource资源</span>
    context<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>mIsSystemOrSystemUiContext <span class="token operator">=</span> <span class="token function">isSystemOrSystemUI</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">LoadedApk</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token class-name">Resources</span> <span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>mResources <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token comment">// 加载APK的Resource资源</span>
         mResources <span class="token operator">=</span> <span class="token class-name">ResourcesManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> mResDir<span class="token punctuation">,</span>
                    splitPaths<span class="token punctuation">,</span> mOverlayDirs<span class="token punctuation">,</span> mApplicationInfo<span class="token punctuation">.</span>sharedLibraryFiles<span class="token punctuation">,</span>
                    <span class="token class-name">Display</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_DISPLAY</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">getCompatibilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">/*触发加载APK的DEX文件*/</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> mResources<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">ClassLoader</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>mClassLoader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token function">createOrUpdateClassLoaderLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/*addedPaths*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> mClassLoader<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createOrUpdateClassLoaderLocked</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> addedPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>mDefaultClassLoader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token comment">// 创建默认的mDefaultClassLoader对象，触发art虚拟机加载dex文件</span>
          mDefaultClassLoader <span class="token operator">=</span> <span class="token class-name">ApplicationLoaders</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoaderWithSharedLibraries</span><span class="token punctuation">(</span>
                    zip<span class="token punctuation">,</span> mApplicationInfo<span class="token punctuation">.</span>targetSdkVersion<span class="token punctuation">,</span> isBundledApp<span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span>
                    libraryPermittedPath<span class="token punctuation">,</span> mBaseClassLoader<span class="token punctuation">,</span>
                    mApplicationInfo<span class="token punctuation">.</span>classLoaderName<span class="token punctuation">,</span> sharedLibraries<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token punctuation">}</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>mClassLoader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 赋值给mClassLoader对象</span>
         mClassLoader <span class="token operator">=</span> mAppComponentFactory<span class="token punctuation">.</span><span class="token function">instantiateClassLoader</span><span class="token punctuation">(</span>mDefaultClassLoader<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">ApplicationInfo</span><span class="token punctuation">(</span>mApplicationInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ApplicationLoaders</span><span class="token punctuation">.</span>java
<span class="token class-name">ClassLoader</span> <span class="token function">getClassLoaderWithSharedLibraries</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// For normal usage the cache key used is the same as the zip path.</span>
    <span class="token keyword">return</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span>zip<span class="token punctuation">,</span> targetSdkVersion<span class="token punctuation">,</span> isBundled<span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span>
                              libraryPermittedPath<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> zip<span class="token punctuation">,</span> classLoaderName<span class="token punctuation">,</span> sharedLibraries<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">ClassLoader</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> zip<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLoaders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">==</span> baseParent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">// 1.创建BootClassLoader加载系统框架类，并增加相应的systrace tag</span>
                <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> zip<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ClassLoader</span> classloader <span class="token operator">=</span> <span class="token class-name">ClassLoaderFactory</span><span class="token punctuation">.</span><span class="token function">createClassLoader</span><span class="token punctuation">(</span>
                        zip<span class="token punctuation">,</span>  librarySearchPath<span class="token punctuation">,</span> libraryPermittedPath<span class="token punctuation">,</span> parent<span class="token punctuation">,</span>
                        targetSdkVersion<span class="token punctuation">,</span> isBundled<span class="token punctuation">,</span> classLoaderName<span class="token punctuation">,</span> sharedLibraries<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> classloader<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 2.创建PathClassLoader加载应用APK的Dex类，并增加相应的systrace tag</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> zip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ClassLoader</span> loader <span class="token operator">=</span> <span class="token class-name">ClassLoaderFactory</span><span class="token punctuation">.</span><span class="token function">createClassLoader</span><span class="token punctuation">(</span>
                    zip<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> parent<span class="token punctuation">,</span> classLoaderName<span class="token punctuation">,</span> sharedLibraries<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> loader<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ClassLoaderFactory</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ClassLoader</span> <span class="token function">createClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过new的方式创建ClassLoader对象，最终会触发art虚拟机加载APK的dex文件</span>
        <span class="token class-name">ClassLoader</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arrayOfSharedLibraries <span class="token operator">=</span> <span class="token punctuation">(</span>sharedLibraries <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token operator">?</span> <span class="token keyword">null</span>
                <span class="token operator">:</span> sharedLibraries<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">[</span>sharedLibraries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPathClassLoaderName</span><span class="token punctuation">(</span>classloaderName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> arrayOfSharedLibraries<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从以上代码可以看出：在创建 <code>Application</code> 的 <code>Context</code> 对象后会立马尝试去加载 APK 的 Resource 资源，而在这之前需要通过 LoadedApk 去创建类加载器 ClassLoader 对象，而这个过程最终就会触发 Art 虚拟机加载应用 APK 的 dex 文件。</p><p><img src="`+M+`" alt=""></p><h3 id="应用apk的resource资源加载" tabindex="-1"><a class="header-anchor" href="#应用apk的resource资源加载" aria-hidden="true">#</a> 应用APK的Resource资源加载</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">LoadedApk</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token class-name">Resources</span> <span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>mResources <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token comment">// 加载APK的Resource资源</span>
         mResources <span class="token operator">=</span> <span class="token class-name">ResourcesManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> mResDir<span class="token punctuation">,</span>
                    splitPaths<span class="token punctuation">,</span> mOverlayDirs<span class="token punctuation">,</span> mApplicationInfo<span class="token punctuation">.</span>sharedLibraryFiles<span class="token punctuation">,</span>
                    <span class="token class-name">Display</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_DISPLAY</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">getCompatibilityInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">/*触发加载APK的DEX文件*/</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> mResources<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ResourcesManager</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Resources</span> <span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 原生Resource资源加载的systrace tag</span>
          <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_RESOURCES</span><span class="token punctuation">,</span> <span class="token string">&quot;ResourcesManager#getResources&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token keyword">return</span> <span class="token function">createResources</span><span class="token punctuation">(</span>activityToken<span class="token punctuation">,</span> key<span class="token punctuation">,</span> classLoader<span class="token punctuation">,</span> assetsSupplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_RESOURCES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Resources</span> <span class="token function">createResources</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// 执行创建Resources资源对象</span>
            <span class="token class-name">ResourcesImpl</span> resourcesImpl <span class="token operator">=</span> <span class="token function">findOrCreateResourcesImplForKeyLocked</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> apkSupplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcesImpl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ResourcesImpl</span> <span class="token function">findOrCreateResourcesImplForKeyLocked</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ResourcesKey</span> key<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ApkAssetsSupplier</span> apkSupplier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      impl <span class="token operator">=</span> <span class="token function">createResourcesImpl</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> apkSupplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ResourcesImpl</span> <span class="token function">createResourcesImpl</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ResourcesKey</span> key<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ApkAssetsSupplier</span> apkSupplier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 创建AssetManager对象，真正实现的APK文件加载解析动作</span>
        <span class="token keyword">final</span> <span class="token class-name">AssetManager</span> assets <span class="token operator">=</span> <span class="token function">createAssetManager</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> apkSupplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">AssetManager</span> <span class="token function">createAssetManager</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> <span class="token class-name">ResourcesKey</span> key<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ApkAssetsSupplier</span> apkSupplier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> apkKeys<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">ApkKey</span> apkKey <span class="token operator">=</span> apkKeys<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 通过loadApkAssets实现应用APK文件的加载</span>
                builder<span class="token punctuation">.</span><span class="token function">addApkAssets</span><span class="token punctuation">(</span>
                        <span class="token punctuation">(</span>apkSupplier <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> apkSupplier<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>apkKey<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">loadApkAssets</span><span class="token punctuation">(</span>apkKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ApkAssets</span> <span class="token function">loadApkAssets</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> <span class="token class-name">ApkKey</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span>overlay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 通过ApkAssets从APK文件所在的路径去加载</span>
            apkAssets <span class="token operator">=</span> <span class="token class-name">ApkAssets</span><span class="token punctuation">.</span><span class="token function">loadFromPath</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
                    key<span class="token punctuation">.</span>sharedLib <span class="token operator">?</span> <span class="token class-name">ApkAssets</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_DYNAMIC</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>content<span class="token operator">/</span>res<span class="token operator">/</span><span class="token class-name">ApkAssets</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ApkAssets</span> <span class="token function">loadFromPath</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token annotation punctuation">@PropertyFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApkAssets</span><span class="token punctuation">(</span><span class="token constant">FORMAT_APK</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* assets */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">ApkAssets</span><span class="token punctuation">(</span><span class="token annotation punctuation">@FormatType</span> <span class="token keyword">int</span> format<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token annotation punctuation">@PropertyFlags</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">AssetsProvider</span> assets<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 通过JNI调用Native层的系统system/lib/libandroidfw.so库中的相关C函数实现对APK文件压缩包的解析与加载</span>
        mNativePtr <span class="token operator">=</span> <span class="token function">nativeLoad</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> path<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从以上代码可以看出：系统对于应用 APK 文件资源的加载过程其实就是创建应用进程中的 Resources 资源对象的过程，其中真正实现 APK 资源文件的 I/O 解析作，最终是借助于 <code>AssetManager</code> 中通过 JNI 调用系统 Native 层的相关 C 函数实现。整个过程从上 Perfetto 看如下图所示：</p><p><img src="`+x+'" alt=""></p><h2 id="activity-的创建与初始化" tabindex="-1"><a class="header-anchor" href="#activity-的创建与初始化" aria-hidden="true">#</a> Activity 的创建与初始化</h2><h3 id="activity-create" tabindex="-1"><a class="header-anchor" href="#activity-create" aria-hidden="true">#</a> Activity Create</h3><p>看看AMS在收到应用进程的 <code>attachApplication</code> 注册请求后，先通过应用及进程的 <code>IApplicationThread#bindApplication</code> 接口，触发应用进程在主线程执行 <code>handleBindApplication</code> 初始化操作，然后继续执行启动应用 <code>Activity</code> 的操作，下面我们来看看系统是如何启动创建应用 <code>Activity</code> 的，简化代码流程如下：</p><p><img src="'+B+`" alt=""></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>am<span class="token operator">/</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IApplicationThread</span> thread<span class="token punctuation">,</span>
        <span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// See if the top visible activity is waiting to run in this process...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>normalMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            didSomething <span class="token operator">=</span> mAtmInternal<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception thrown launching activities in &quot;</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>wm<span class="token operator">/</span><span class="token class-name">ActivityTaskManagerService</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">WindowProcessController</span> wpc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLockWithoutBoost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;attachApplication:&quot;</span> <span class="token operator">+</span> wpc<span class="token punctuation">.</span>mName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mRootWindowContainer<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>wpc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>wm<span class="token operator">/</span><span class="token class-name">RootWindowContainer</span><span class="token punctuation">.</span>java
<span class="token keyword">boolean</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">WindowProcessController</span> app<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mAttachApplicationHelper<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mAttachApplicationHelper<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>wm<span class="token operator">/</span><span class="token class-name">RootWindowContainer</span><span class="token punctuation">.</span>java
<span class="token keyword">boolean</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WindowProcessController</span> app<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
    mApp <span class="token operator">=</span> app<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> <span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> displayNdx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">getChildAt</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRemoteException <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> mRemoteException<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHasActivityStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ensureActivitiesVisible</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/* starting */</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* configChanges */</span><span class="token punctuation">,</span>
                <span class="token boolean">false</span> <span class="token comment">/* preserveWindows */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mHasActivityStarted<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>wm<span class="token operator">/</span><span class="token class-name">WindowContainer</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">forAllRootTasks</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* traverseTopToBottom */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> traverseTopToBottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>traverseTopToBottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> traverseTopToBottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> traverseTopToBottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Root tasks may be removed from this display. Ensure each task will be processed</span>
            <span class="token comment">// and the loop will end.</span>
            <span class="token keyword">int</span> newCount <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i <span class="token operator">-=</span> count <span class="token operator">-</span> newCount<span class="token punctuation">;</span>
            count <span class="token operator">=</span> newCount<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>wm<span class="token operator">/</span><span class="token class-name">Task</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> traverseTopToBottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        callback<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@accept</span><span class="token operator">:</span><span class="token number">3600</span><span class="token punctuation">,</span> <span class="token class-name">RootWindowContainer</span>$<span class="token class-name">AttachApplicationHelper</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">Task</span> rootTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mRemoteException <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rootTask<span class="token punctuation">.</span><span class="token function">getVisibility</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/* starting */</span><span class="token punctuation">)</span>
            <span class="token operator">==</span> <span class="token constant">TASK_FRAGMENT_VISIBILITY_INVISIBLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mTop <span class="token operator">=</span> rootTask<span class="token punctuation">.</span><span class="token function">topRunningActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rootTask<span class="token punctuation">.</span><span class="token function">forAllActivities</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

forAllActivities<span class="token operator">:</span><span class="token number">1678</span><span class="token punctuation">,</span> <span class="token class-name">WindowContainer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">)</span>
<span class="token keyword">boolean</span> <span class="token function">forAllActivities</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">forAllActivities</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/*traverseTopToBottom*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

forAllActivities<span class="token operator">:</span><span class="token number">1684</span><span class="token punctuation">,</span> <span class="token class-name">WindowContainer</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">)</span>
<span class="token keyword">boolean</span> <span class="token function">forAllActivities</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> traverseTopToBottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>traverseTopToBottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forAllActivities</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> traverseTopToBottom<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> count <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forAllActivities</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> traverseTopToBottom<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

forAllActivities<span class="token operator">:</span><span class="token number">4585</span><span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">)</span>
<span class="token keyword">boolean</span> <span class="token function">forAllActivities</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> traverseTopToBottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> callback<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


test<span class="token operator">:</span><span class="token number">3612</span><span class="token punctuation">,</span> <span class="token class-name">RootWindowContainer</span>$<span class="token class-name">AttachApplicationHelper</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span>wm<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>finishing <span class="token operator">||</span> <span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">showToCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>visibleIgnoringKeyguard
            <span class="token operator">||</span> r<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> mApp<span class="token punctuation">.</span>mUid <span class="token operator">!=</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid
            <span class="token operator">||</span> <span class="token operator">!</span>mApp<span class="token punctuation">.</span>mName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mTaskSupervisor<span class="token punctuation">.</span><span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> mApp<span class="token punctuation">,</span>
                mTop <span class="token operator">==</span> r <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">canBeResumed</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token comment">/* andResume */</span><span class="token punctuation">,</span>
                <span class="token boolean">true</span> <span class="token comment">/* checkConfig */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mHasActivityStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Exception in new application when starting activity &quot;</span> <span class="token operator">+</span> mTop<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mRemoteException <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>services<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>server<span class="token operator">/</span>wm<span class="token operator">/</span><span class="token class-name">ActivityTaskSupervisor</span><span class="token punctuation">.</span>java
<span class="token keyword">boolean</span> <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">WindowProcessController</span> proc<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 1.先通过LaunchActivityItem封装Binder通知应用进程执行Launch Activity动作       </span>
         clientTransaction<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token class-name">LaunchActivityItem</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// Set desired final state.</span>
         <span class="token keyword">final</span> <span class="token class-name">ActivityLifecycleItem</span> lifecycleItem<span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>andResume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 2.再通过ResumeActivityItem封装Binder通知应用进程执行Launch Resume动作        </span>
                lifecycleItem <span class="token operator">=</span> <span class="token class-name">ResumeActivityItem</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>dc<span class="token punctuation">.</span><span class="token function">isNextTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         clientTransaction<span class="token punctuation">.</span><span class="token function">setLifecycleStateRequest</span><span class="token punctuation">(</span>lifecycleItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 执行以上封装的Binder调用</span>
         mService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>clientTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从以上代码分析可以看到，框架 system_server 进程最终是通过 <code>ActivityStackSupervisor#realStartActivityLocked</code> 函数中，通过 <code>LaunchActivityItem</code> 和 <code>ResumeActivityItem</code> 两个类的封装，依次实现 binder 调用通知应用进程这边执行 <code>Activity</code> 的 <code>Launch</code> 和 <code>Resume</code> 动作的，我们继续往下看相关代码流程：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span>servertransaction<span class="token operator">/</span><span class="token class-name">LaunchActivityItem</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> client<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span>
        <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;activityStart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ActivityClientRecord</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityClientRecord</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> mIntent<span class="token punctuation">,</span> mIdent<span class="token punctuation">,</span> mInfo<span class="token punctuation">,</span>
            mOverrideConfig<span class="token punctuation">,</span> mCompatInfo<span class="token punctuation">,</span> mReferrer<span class="token punctuation">,</span> mVoiceInteractor<span class="token punctuation">,</span> mState<span class="token punctuation">,</span> mPersistentState<span class="token punctuation">,</span>
            mPendingResults<span class="token punctuation">,</span> mPendingNewIntents<span class="token punctuation">,</span> mActivityOptions<span class="token punctuation">,</span> mIsForward<span class="token punctuation">,</span> mProfilerInfo<span class="token punctuation">,</span>
            client<span class="token punctuation">,</span> mAssistToken<span class="token punctuation">,</span> mShareableActivityToken<span class="token punctuation">,</span> mLaunchedFromBubble<span class="token punctuation">,</span>
            mTaskFragmentToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> pendingActions<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* customIntent */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token class-name">Activity</span> <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span>
        <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">final</span> <span class="token class-name">Activity</span> a <span class="token operator">=</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> customIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token class-name">Activity</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 1.创建Activity的Context</span>
        <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//2.反射创建Activity对象</span>
            activity <span class="token operator">=</span> mInstrumentation<span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>
                    cl<span class="token punctuation">,</span> component<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">// 3.执行Activity的attach动作</span>
                activity<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">// 4.执行应用Activity的onCreate生命周期函数,并在setContentView调用中创建DecorView对象</span>
                mInstrumentation<span class="token punctuation">.</span><span class="token function">callActivityOnCreate</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> r<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SuperNotCalledException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">Activity</span><span class="token punctuation">.</span>java
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 1.创建表示应用窗口的PhoneWindow对象</span>
    mWindow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhoneWindow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> window<span class="token punctuation">,</span> activityConfigCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 2.为PhoneWindow配置WindowManager</span>
    mWindow<span class="token punctuation">.</span><span class="token function">setWindowManager</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token class-name">WindowManager</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">WINDOW_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            mToken<span class="token punctuation">,</span> mComponent<span class="token punctuation">.</span><span class="token function">flattenToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>info<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span><span class="token constant">FLAG_HARDWARE_ACCELERATED</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">Instrumentation</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callActivityOnCreate</span><span class="token punctuation">(</span><span class="token class-name">Activity</span> activity<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> icicle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    activity<span class="token punctuation">.</span><span class="token function">performCreate</span><span class="token punctuation">(</span>icicle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">Activity</span><span class="token punctuation">.</span>java
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">performCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> icicle<span class="token punctuation">,</span> <span class="token class-name">PersistableBundle</span> persistentState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;performCreate:&quot;</span>
                <span class="token operator">+</span> mComponent<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>persistentState <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onCreate</span><span class="token punctuation">(</span>icicle<span class="token punctuation">,</span> persistentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">onCreate</span><span class="token punctuation">(</span>icicle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上面代码可以看出，应用进程这边在收到系统 binder 调用后，在主线程中创建 Activity 的流程主要步骤如下：</p><ul><li>创建 <code>Activity</code> 的 <code>Context</code>；</li><li>通过反射创建 <code>Activity</code> 对象；</li><li>执行 <code>Activity</code>的 <code>attach</code> 动作，其中会创建应用窗口的<code>PhoneWindow</code> 对象并设置<code>WindowManager</code>；</li><li>执行应用 <code>Activity</code> 的 <code>onCreate</code> 生命周期函数，并在 <code>setContentView</code> 中创建窗口的 <code>DecorView</code> 对象；</li></ul><p><img src="`+F+`" alt=""></p><h3 id="activity-resume" tabindex="-1"><a class="header-anchor" href="#activity-resume" aria-hidden="true">#</a> Activity Resume</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span>servertransaction<span class="token operator">/</span><span class="token class-name">ResumeActivityItem</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> client<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span>
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 原生标识Activity Resume的systrace tag</span>
   <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;activityResume&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   client<span class="token punctuation">.</span><span class="token function">handleResumeActivity</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* finalStateRequest */</span><span class="token punctuation">,</span> mIsForward<span class="token punctuation">,</span>
                <span class="token string">&quot;RESUME_ACTIVITY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleResumeActivity</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 1.执行performResumeActivity流程,执行应用Activity的onResume生命周期函数</span>
    <span class="token comment">// TODO Push resumeArgs into the activity for consideration</span>
    <span class="token comment">// skip below steps for double-resume and r.mFinish = true case.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">performResumeActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> finalStateRequest<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>window <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>a<span class="token punctuation">.</span>mFinished <span class="token operator">&amp;&amp;</span> willBeVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>mVisibleFromClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>a<span class="token punctuation">.</span>mWindowAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token comment">// 2.执行WindowManager#addView动作开启视图绘制逻辑</span>
                    wm<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>decor<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">performResumeActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finalStateRequest<span class="token punctuation">,</span>
        <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">performResume</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>startsNotResumed<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">WindowManagerImpl</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mGlobal<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> params<span class="token punctuation">,</span> mContext<span class="token punctuation">.</span><span class="token function">getDisplayNoVerify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mParentWindow<span class="token punctuation">,</span>
            mContext<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">WindowManagerGlobal</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">ViewGroup<span class="token punctuation">.</span>LayoutParams</span> params<span class="token punctuation">,</span>
        <span class="token class-name">Display</span> display<span class="token punctuation">,</span> <span class="token class-name">Window</span> parentWindow<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token class-name">ViewRootImpl</span> root<span class="token punctuation">;</span>
    <span class="token class-name">View</span> panelParentView <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowlessSession <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewRootImpl</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> display<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewRootImpl</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> display<span class="token punctuation">,</span>
                    windowlessSession<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WindowlessWindowLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        view<span class="token punctuation">.</span><span class="token function">setLayoutParams</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mViews<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mRoots<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mParams<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wparams<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// do this last because it fires off messages to start doing things</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            root<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> wparams<span class="token punctuation">,</span> panelParentView<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> attrs<span class="token punctuation">,</span> <span class="token class-name">View</span> panelParentView<span class="token punctuation">,</span>
        <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mView <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mView <span class="token operator">=</span> view<span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token comment">// Schedule the first layout -before- adding to the window</span>
            <span class="token comment">// manager, to make sure we do the relayout before receiving</span>
            <span class="token comment">// any other events from the system.</span>
            <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上面代码可以看出，应用进程这边在接收到系统Binder调用请求后，在主线程中 Activity Resume 的流程主要步骤如下：</p><ul><li>执行应用Activity的onResume生命周期函数;</li><li>执行WindowManager的addView动作开启视图绘制逻辑;</li><li>创建Activity的ViewRootImpl对象;</li><li>执行ViewRootImpl的setView函数开启UI界面绘制动作；</li></ul><p>从 Perfetto 上看整个过程如下图所示：</p><p><img src="`+q+'" alt=""></p><h2 id="布局与绘制" tabindex="-1"><a class="header-anchor" href="#布局与绘制" aria-hidden="true">#</a> 布局与绘制</h2><p>接上一节的分析，应用主线程中在执行 <code>Activity</code>的 <code>Resume</code> 流程的最后，会创建 <code>ViewRootImpl</code> 对象并调用其 <code>setView</code> 函数，从此并开启了应用界面UI布局与绘制的流程。在开始讲解这个过程之前，我们先来整理一下前面代码中讲到的这些概念，如<code>Activity</code>、<code>PhoneWindow</code>、<code>DecorView</code>、<code>ViewRootImpl</code>、<code>WindowManager</code>它们之间的关系与职责，因为这些核心类基本构成了 Android 系统的GUI显示系统在应用进程侧的核心架构，其整体架构如下图所示：</p><p><img src="'+W+`" alt=""></p><ul><li><p><code>Window</code> 是一个抽象类，通过控制 <code>DecorView</code> 提供了一些标准的UI方案，比如背景、标题、虚拟按键等，而 <code>PhoneWindow</code> 是 <code>Window</code> 的唯一实现类，在 <code>Activity</code> 创建后的 <code>attach</code> 流程中创建，应用启动显示的内容装载到其内部的 <code>mDecor（DecorView）</code>；</p></li><li><p><code>DecorView</code> 是整个界面布局 <code>View</code> 控件树的根节点，通过它可以遍历访问到整个 <code>View</code> 控件树上的任意节点；</p></li><li><p><code>WindowManager</code> 是一个接口，继承自 <code>ViewManager</code> 接口，提供了 <code>View</code> 的基本操作方法；<code>WindowManagerImp</code> 实现了 <code>WindowManager</code> 接口，内部通过组合方式持有 <code>WindowManagerGlobal</code> ，用来操作 <code>View</code> ；</p></li><li><p><code>WindowManagerGlobal</code> 是一个全局单例，内部可以通过<code>ViewRootImpl</code> 将 <code>View</code> 添加至窗口中；</p></li><li><p><code>ViewRootImpl</code> 是所有 <code>View</code> 的 Parent，用来总体管理 <code>View</code> 的绘制以及与系统WMS窗口管理服务的IPC交互从而实现窗口的开辟；<code>ViewRootImpl</code> 是应用进程运转的发动机，可以看到 <code>ViewRootImpl</code> 内部包含 <code>mView（就是DecorView）</code>、<code>mSurface</code>、<code>Choregrapher</code>，<code>mView</code> 代表整个控件树， <code>mSurface</code> 代表画布，应用的UI渲染会直接放到 <code>mSurface</code> 中，<code>Choreographer</code> 使得应用请求vsync信号，接收信号后开始渲染流程；</p></li></ul><p>我们从 <code>ViewRootImpl</code> 的 <code>setView</code> 流程继续结合代码往下看：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setView</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> attrs<span class="token punctuation">,</span> <span class="token class-name">View</span> panelParentView<span class="token punctuation">,</span>
            <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>mView <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             mView <span class="token operator">=</span> view<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token comment">// 开启绘制硬件加速，初始化RenderThread渲染线程运行环境</span>
         <span class="token function">enableHardwareAcceleration</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token comment">// 1.触发绘制动作</span>
         <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         inputChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token comment">// 2.Binder调用访问系统窗口管理服务WMS接口，实现addWindow添加注册应用窗口的操作,并传入inputChannel用于接收触控事件</span>
         res <span class="token operator">=</span> mWindowSession<span class="token punctuation">.</span><span class="token function">addToDisplayAsUser</span><span class="token punctuation">(</span>mWindow<span class="token punctuation">,</span> mSeq<span class="token punctuation">,</span> mWindowAttributes<span class="token punctuation">,</span>
                            <span class="token function">getHostVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mDisplay<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> mTmpFrame<span class="token punctuation">,</span>
                            mAttachInfo<span class="token punctuation">.</span>mContentInsets<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">.</span>mStableInsets<span class="token punctuation">,</span>
                            mAttachInfo<span class="token punctuation">.</span>mDisplayCutout<span class="token punctuation">,</span> inputChannel<span class="token punctuation">,</span>
                            mTempInsets<span class="token punctuation">,</span> mTempControls<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token comment">// 3.创建WindowInputEventReceiver对象，实现应用窗口接收触控事件</span>
         mInputEventReceiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowInputEventReceiver</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">,</span>
                            <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token comment">// 4.设置DecorView的mParent为ViewRootImpl</span>
         view<span class="token punctuation">.</span><span class="token function">assignParent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从以上代码可以看出 <code>ViewRootImpl</code> 的 <code>setView</code> 内部关键流程如下：</p><ul><li><p><code>requestLayout()</code> 通过一系列调用触发界面绘制（measure、layout、draw）动作，下文会详细展开分析；</p></li><li><p>通过Binder调用访问系统窗口管理服务WMS的 <code>addWindow</code> 接口，实现添加、注册应用窗口的操作，并传入本地创建 <code>inputChannel</code> 对象用于后续接收系统的触控事件，这一步执行完我们的View就可以显示到屏幕上了。关于WMS的内部实现流程也非常复杂，由于篇幅有限本文就不详细展开分析了。</p></li><li><p>创建 <code>WindowInputEventReceiver</code> 对象，封装实现应用窗口接收系统触控事件的逻辑；</p></li><li><p>执行 <code>view.assignParent(this)</code>，设置 <code>DecorView</code> 的 <code>mParent</code> 为 <code>ViewRootImpl</code>。所以，虽然 <code>ViewRootImpl</code> 不是一个<code>View</code>, 但它是所有 <code>View</code> 的顶层 Parent。</p></li></ul><p>我们顺着 <code>ViewRootImpl</code> 的 <code>requestLayout</code> 动作继续往下看界面绘制的流程代码:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHandlingLayoutInLayoutRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 检查当前UI绘制操作是否发生在主线程，如果发生在子线程则会抛出异常</span>
         <span class="token function">checkThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         mLayoutRequested <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token comment">// 触发绘制操作</span>
         <span class="token function">scheduleTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">scheduleTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTraversalScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token comment">// 注意此处会往主线程的MessageQueue消息队列中添加同步栏删，因为系统绘制消息属于异步消息，需要更高优先级的处理</span>
         mTraversalBarrier <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postSyncBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 通过Choreographer往主线程消息队列添加CALLBACK_TRAVERSAL绘制类型的待执行消息，用于触发后续UI线程真正实现绘制动作</span>
         mChoreographer<span class="token punctuation">.</span><span class="token function">postCallback</span><span class="token punctuation">(</span>
                    <span class="token class-name">Choreographer</span><span class="token punctuation">.</span><span class="token constant">CALLBACK_TRAVERSAL</span><span class="token punctuation">,</span> mTraversalRunnable<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">Choreographer</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postCallback</span><span class="token punctuation">(</span><span class="token keyword">int</span> callbackType<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> action<span class="token punctuation">,</span> <span class="token class-name">Object</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">postCallbackDelayed</span><span class="token punctuation">(</span>callbackType<span class="token punctuation">,</span> action<span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">Choreographer</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postCallbackDelayed</span><span class="token punctuation">(</span><span class="token keyword">int</span> callbackType<span class="token punctuation">,</span>
        <span class="token class-name">Runnable</span> action<span class="token punctuation">,</span> <span class="token class-name">Object</span> token<span class="token punctuation">,</span> <span class="token keyword">long</span> delayMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;action must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackType <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> callbackType <span class="token operator">&gt;</span> <span class="token constant">CALLBACK_LAST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;callbackType is invalid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">postCallbackDelayedInternal</span><span class="token punctuation">(</span>callbackType<span class="token punctuation">,</span> action<span class="token punctuation">,</span> token<span class="token punctuation">,</span> delayMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">Choreographer</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">postCallbackDelayedInternal</span><span class="token punctuation">(</span><span class="token keyword">int</span> callbackType<span class="token punctuation">,</span>
        <span class="token class-name">Object</span> action<span class="token punctuation">,</span> <span class="token class-name">Object</span> token<span class="token punctuation">,</span> <span class="token keyword">long</span> delayMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_FRAMES</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;PostCallback: type=&quot;</span> <span class="token operator">+</span> callbackType
                <span class="token operator">+</span> <span class="token string">&quot;, action=&quot;</span> <span class="token operator">+</span> action <span class="token operator">+</span> <span class="token string">&quot;, token=&quot;</span> <span class="token operator">+</span> token
                <span class="token operator">+</span> <span class="token string">&quot;, delayMillis=&quot;</span> <span class="token operator">+</span> delayMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> dueTime <span class="token operator">=</span> now <span class="token operator">+</span> delayMillis<span class="token punctuation">;</span>
        mCallbackQueues<span class="token punctuation">[</span>callbackType<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">addCallbackLocked</span><span class="token punctuation">(</span>dueTime<span class="token punctuation">,</span> action<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>dueTime <span class="token operator">&lt;=</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">scheduleFrameLocked</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span><span class="token constant">MSG_DO_SCHEDULE_CALLBACK</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> callbackType<span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mHandler<span class="token punctuation">.</span><span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> dueTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">Choreographer</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scheduleFrameLocked</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mFrameScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mFrameScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">USE_VSYNC</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            
            <span class="token comment">// If running on the Looper thread, then schedule the vsync immediately,</span>
            <span class="token comment">// otherwise post a message to schedule the vsync from the UI thread</span>
            <span class="token comment">// as soon as possible.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunningOnLooperThreadLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">scheduleVsyncLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">Choreographer</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scheduleVsyncLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_VIEW</span><span class="token punctuation">,</span> <span class="token string">&quot;Choreographer#scheduleVsyncLocked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDisplayEventReceiver<span class="token punctuation">.</span><span class="token function">scheduleVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_VIEW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Choreographer</code> 的引入，主要是配合系统 Vsync 垂直同步机制（Android“黄油计划”中引入的机制之一，协调APP生成UI数据和 <code>SurfaceFlinger</code> 合成图像，避免Tearing画面撕裂的现象），给上层 App 的渲染提供一个稳定的 Message 处理的时机，也就是 Vsync 到来的时候 ，系统通过对 Vsync 信号周期的调整，来控制每一帧绘制操作的时机。<code>Choreographer</code> 扮演 Android 渲染链路中承上启下的角色：</p><ul><li><p>承上：负责接收和处理 App 的各种更新消息和回调，等到 Vsync 到来的时候统一处理。比如集中处理 Input(主要是 Input 事件的处理) 、Animation(动画相关)、Traversal(包括 measure、layout、draw 等操作) ，判断卡顿掉帧情况，记录 CallBack 耗时等；</p></li><li><p>启下：负责请求和接收 Vsync 信号。接收 Vsync 事件回调(通过 <code>FrameDisplayEventReceiver.onVsync</code> )，请求 <code>Vsync(FrameDisplayEventReceiver.scheduleVsync</code>) 。</p></li></ul><p><code>Choreographer</code> 在收到 <code>CALLBACK_TRAVERSAL</code> 类型的绘制任务后，其内部的工作流程如下图所示：</p><p><img src="`+O+'" alt=""></p><p>从以上流程图可以看出：<code>ViewRootImpl</code> 调用 <code>Choreographer</code> 的 <code>postCallback</code> 接口放入待执行的绘制消息后，<code>Choreographer</code>会先向系统申请 APP 类型的 vsync 信号，然后等待系统 vsync 信号到来后，去回调到 <code>ViewRootImpl</code> 的 <code>doTraversal</code> 函数中执行真正的绘制动作（measure、layout、draw）。这个绘制过程从 Perfetto 上看如下图所示：</p><p><img src="'+G+'" alt=""></p><p><img src="'+z+'" alt=""></p><p><img src="'+U+`" alt=""></p><p>我们接着 <code>ViewRootImpl</code> 的 <code>doTraversal</code> 函数的简化代码流程往下看：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">doTraversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>mTraversalScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         mTraversalScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
         <span class="token comment">// 调用removeSyncBarrier及时移除主线程MessageQueue中的Barrier同步栏删，以避免主线程发生“假死”</span>
         mHandler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeSyncBarrier</span><span class="token punctuation">(</span>mTraversalBarrier<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token comment">// 执行具体的绘制任务</span>
         <span class="token function">performTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token comment">// 1.从DecorView根节点出发，遍历整个View控件树，完成整个View控件树的measure测量操作</span>
     windowSizeMayChange <span class="token operator">|=</span> <span class="token function">measureHierarchy</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>mFirst<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2.第一次执行traversals绘制任务时，Binder调用访问系统窗口管理服务WMS的relayoutWindow接口，实现WMS计算应用窗口尺寸并向系统surfaceflinger正式申请Surface“画布”操作</span>
         relayoutResult <span class="token operator">=</span> <span class="token function">relayoutWindow</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> viewVisibility<span class="token punctuation">,</span> insetsPending<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token comment">// 3.从DecorView根节点出发，遍历整个View控件树，完成整个View控件树的layout测量操作</span>
     <span class="token function">performLayout</span><span class="token punctuation">(</span>lp<span class="token punctuation">,</span> mWidth<span class="token punctuation">,</span> mHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token comment">// 4.从DecorView根节点出发，遍历整个View控件树，完成整个View控件树的draw测量操作</span>
     <span class="token function">performDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">relayoutWindow</span><span class="token punctuation">(</span><span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span> params<span class="token punctuation">,</span> <span class="token keyword">int</span> viewVisibility<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> insetsPending<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 通过Binder IPC访问系统WMS服务的relayout接口，申请Surface“画布”操作</span>
        <span class="token keyword">int</span> relayoutResult <span class="token operator">=</span> mWindowSession<span class="token punctuation">.</span><span class="token function">relayout</span><span class="token punctuation">(</span>mWindow<span class="token punctuation">,</span> mSeq<span class="token punctuation">,</span> params<span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>mView<span class="token punctuation">.</span><span class="token function">getMeasuredWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> appScale <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>mView<span class="token punctuation">.</span><span class="token function">getMeasuredHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> appScale <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">,</span> viewVisibility<span class="token punctuation">,</span>
                insetsPending <span class="token operator">?</span> <span class="token class-name">WindowManagerGlobal</span><span class="token punctuation">.</span><span class="token constant">RELAYOUT_INSETS_PENDING</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> frameNumber<span class="token punctuation">,</span>
                mTmpFrame<span class="token punctuation">,</span> mTmpRect<span class="token punctuation">,</span> mTmpRect<span class="token punctuation">,</span> mTmpRect<span class="token punctuation">,</span> mPendingBackDropFrame<span class="token punctuation">,</span>
                mPendingDisplayCutout<span class="token punctuation">,</span> mPendingMergedConfiguration<span class="token punctuation">,</span> mSurfaceControl<span class="token punctuation">,</span> mTempInsets<span class="token punctuation">,</span>
                mTempControls<span class="token punctuation">,</span> mSurfaceSize<span class="token punctuation">,</span> mBlastSurfaceControl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSurfaceControl<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">useBLAST</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 本地Surface对象获取指向远端分配的Surface的引用</span>
                mSurface<span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span>mSurfaceControl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performMeasure</span><span class="token punctuation">(</span><span class="token keyword">int</span> childWidthMeasureSpec<span class="token punctuation">,</span> <span class="token keyword">int</span> childHeightMeasureSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 原生标识View树的measure测量过程的trace tag</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_VIEW</span><span class="token punctuation">,</span> <span class="token string">&quot;measure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 从mView指向的View控件树的根节点DecorView出发，遍历访问整个View树，并完成整个布局View树的测量工作</span>
            mView<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span>childWidthMeasureSpec<span class="token punctuation">,</span> childHeightMeasureSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_VIEW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">boolean</span> canUseAsync <span class="token operator">=</span> <span class="token function">draw</span><span class="token punctuation">(</span>fullRedrawNeeded<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fullRedrawNeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 如果开启并支持硬件绘制加速，则走硬件绘制的流程（从Android 4.+开始，默认情况下都是支持跟开启了硬件加速的）</span>
        mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>mView<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 否则走drawSoftware软件绘制的流程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">drawSoftware</span><span class="token punctuation">(</span>surface<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">,</span> xOffset<span class="token punctuation">,</span> yOffset<span class="token punctuation">,</span>
                        scalingRequired<span class="token punctuation">,</span> dirty<span class="token punctuation">,</span> surfaceInsets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上面的代码流程可以看出，<code>ViewRootImpl</code> 中负责的整个应用界面绘制的主要流程如下：</p><ul><li><p>从界面View控件树的根节点 <code>DecorView</code> 出发，递归遍历整个 <code>View</code> 控件树，完成对整个 <code>View</code> 控件树的 <code>measure</code> 测量操作，由于篇幅所限，本文就不展开分析这块的详细流程；</p></li><li><p>界面第一次执行绘制任务时，会通过Binder IPC访问系统窗口管理服务WMS的relayout接口，实现窗口尺寸的计算并向系统申请用于本地绘制渲染的Surface“画布”的操作（具体由SurfaceFlinger负责创建应用界面对应的BufferQueueLayer对象，并通过内存共享的方式通过Binder将地址引用透过WMS回传给应用进程这边），由于篇幅所限，本文就不展开分析这块的详细流程；</p></li><li><p>从界面 <code>View</code> 控件树的根节点 <code>DecorView</code> 出发，递归遍历整个 <code>View</code> 控件树，完成对整个 <code>View</code> 控件树的 <code>layout</code> 测量操作；</p></li><li><p>从界面 <code>View</code> 控件树的根节点 <code>DecorView</code> 出发，递归遍历整个 <code>View</code> 控件树，完成对整个 <code>View</code> 控件树的 <code>draw</code> 测量操作，如果开启并支持硬件绘制加速（从Android 4.X开始谷歌已经默认开启硬件加速），则走GPU硬件绘制的流程，否则走CPU软件绘制的流程；</p></li></ul><p>借用一张图来总结应用UI绘制的流程，如下所示：</p><p><img src="`+e+`" alt=""></p><h2 id="renderthread-渲染" tabindex="-1"><a class="header-anchor" href="#renderthread-渲染" aria-hidden="true">#</a> RenderThread 渲染</h2><p>截止到目前，在 <code>ViewRootImpl</code> 中完成了对界面的 <code>measure</code>、 <code>layout</code> 和 <code>draw</code> 等绘制流程后，用户依然还是看不到屏幕上显示的应用界面内容，因为整个 Android 系统的显示流程除了前面讲到的UI线程的绘制外，界面还需要经过 <code>RenderThread</code> 线程的渲染处理，渲染完成后，还需要通过Binder调用“上帧”交给 <code>surfaceflinger</code> 进程中进行合成后送显才能最终显示到屏幕上。</p><p>本小节中，我们将接上一节中 <code>ViewRootImpl</code> 中最后 <code>draw</code> 的流程继续往下分析开启硬件加速情况下，<code>RenderThread</code> 渲染线程的工作流程。由于目前Android 4.X之后系统默认界面是开启硬件加速的，所以本文我们重点分析硬件加速条件下的界面渲染流程，我们先分析一下简化的代码流程：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">doTraversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mTraversalScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token function">performTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performTraversals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isViewVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cancelAndRedraw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">performDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mSyncBufferCallback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mSyncBufferCallback<span class="token punctuation">.</span><span class="token function">onBufferReady</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">performDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> canUseAsync <span class="token operator">=</span> <span class="token function">draw</span><span class="token punctuation">(</span>fullRedrawNeeded<span class="token punctuation">,</span> usingAsyncReport <span class="token operator">&amp;&amp;</span> mSyncBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_VIEW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fullRedrawNeeded<span class="token punctuation">,</span> <span class="token keyword">boolean</span> forceDraw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirty<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> mIsAnimating <span class="token operator">||</span> accessibilityFocusDirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHardwareEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            
            mAttachInfo<span class="token punctuation">.</span>mThreadedRenderer<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>mView<span class="token punctuation">,</span> mAttachInfo<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> useAsyncReport<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ThreadedRenderer</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">AttachInfo</span> attachInfo<span class="token punctuation">,</span> <span class="token class-name">DrawCallbacks</span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    attachInfo<span class="token punctuation">.</span>mViewRootImpl<span class="token punctuation">.</span>mViewFrameInfo<span class="token punctuation">.</span><span class="token function">markDrawStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.从DecorView根节点出发，递归遍历View控件树，记录每个View节点的绘制操作命令，完成绘制操作命令树的构建</span>
    <span class="token function">updateRootDisplayList</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
    <span class="token comment">// 2.JNI调用同步Java层构建的绘制命令树到Native层的RenderThread渲染线程，并唤醒渲染线程利用OpenGL执行渲染任务；</span>
    <span class="token keyword">int</span> syncResult <span class="token operator">=</span> <span class="token function">syncAndDrawFrame</span><span class="token punctuation">(</span>frameInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">syncAndDrawFrame</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">FrameInfo</span> frameInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">nSyncAndDrawFrame</span><span class="token punctuation">(</span>mNativeProxy<span class="token punctuation">,</span> frameInfo<span class="token punctuation">.</span>frameInfo<span class="token punctuation">,</span> frameInfo<span class="token punctuation">.</span>frameInfo<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+e+`" alt=""></p><p>从上面的代码可以看出，硬件加速绘制主要包括两个阶段：</p><ul><li><p>从 <code>DecorView</code> 根节点出发，递归遍历 <code>View</code> 控件树，记录每个 <code>View</code> 节点的 <code>drawOp</code> 绘制操作命令，完成绘制操作命令树的构建；</p></li><li><p>JNI 调用同步 Java 层构建的绘制命令树到 Native 层的 <code>RenderThread</code> 渲染线程，并唤醒渲染线程利用OpenGL执行渲染任务；</p></li></ul><h3 id="构建绘制命令树" tabindex="-1"><a class="header-anchor" href="#构建绘制命令树" aria-hidden="true">#</a> 构建绘制命令树</h3><p>我们先来看看第一阶段构建绘制命令树的代码简化流程：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ThreadedRenderer</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateRootDisplayList</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">DrawCallbacks</span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 原生标记构建View绘制操作命令树过程的systrace tag</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_VIEW</span><span class="token punctuation">,</span> <span class="token string">&quot;Record View#draw()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 递归子View的updateDisplayListIfDirty实现构建DisplayListOp</span>
        <span class="token function">updateViewTreeDisplayList</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRootNodeNeedsUpdate <span class="token operator">||</span> <span class="token operator">!</span>mRootNode<span class="token punctuation">.</span><span class="token function">hasDisplayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取根View的SkiaRecordingCanvas</span>
            <span class="token class-name">RecordingCanvas</span> canvas <span class="token operator">=</span> mRootNode<span class="token punctuation">.</span><span class="token function">beginRecording</span><span class="token punctuation">(</span>mSurfaceWidth<span class="token punctuation">,</span> mSurfaceHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">// 利用canvas缓存DisplayListOp绘制命令</span>
                canvas<span class="token punctuation">.</span><span class="token function">drawRenderNode</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">updateDisplayListIfDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// 将所有DisplayListOp绘制命令填充到RootRenderNode中</span>
                mRootNode<span class="token punctuation">.</span><span class="token function">endRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_VIEW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">ThreadedRenderer</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateViewTreeDisplayList</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 从DecorView根节点出发，开始递归调用每个View树节点的updateDisplayListIfDirty函数</span>
        view<span class="token punctuation">.</span><span class="token function">updateDisplayListIfDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">View</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token class-name">RenderNode</span> <span class="token function">updateDisplayListIfDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token comment">// 1.利用\`View\`对象构造时创建的\`RenderNode\`获取一个\`SkiaRecordingCanvas\`“画布”；</span>
     <span class="token keyword">final</span> <span class="token class-name">RecordingCanvas</span> canvas <span class="token operator">=</span> renderNode<span class="token punctuation">.</span><span class="token function">beginRecording</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> <span class="token constant">PFLAG_SKIP_DRAW</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">PFLAG_SKIP_DRAW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 如果仅仅是ViewGroup，并且自身不用绘制，直接递归子View</span>
              <span class="token function">dispatchDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// 2.利用SkiaRecordingCanvas，在每个子View控件的onDraw绘制函数中调用drawLine、drawRect等绘制操作时，创建对应的DisplayListOp绘制命令，并缓存记录到其内部的SkiaDisplayList持有的DisplayListData中；</span>
              <span class="token function">draw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         <span class="token comment">// 3.将包含有\`DisplayListOp\`绘制命令缓存的\`SkiaDisplayList\`对象设置填充到\`RenderNode\`中；</span>
         renderNode<span class="token punctuation">.</span><span class="token function">endRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token punctuation">}</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">View</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// draw the content(View自己实现的onDraw绘制，由应用开发者自己实现)</span>
    <span class="token function">onDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// draw the children</span>
    <span class="token function">dispatchDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>graphics<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>graphics<span class="token operator">/</span><span class="token class-name">RenderNode</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">endRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 从SkiaRecordingCanvas中获取SkiaDisplayList对象</span>
        <span class="token keyword">long</span> displayList <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">finishRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将SkiaDisplayList对象填充到RenderNode中</span>
        <span class="token function">nSetDisplayList</span><span class="token punctuation">(</span>mNativeRenderNode<span class="token punctuation">,</span> displayList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从以上代码可以看出，构建绘制命令树的过程是从 <code>View</code> 控件树的根节点 <code>DecorView</code> 触发，递归调用每个子 <code>View</code> 节点的 <code>updateDisplayListIfDirty</code> 函数，最终完成绘制树的创建，简述流程如下：</p><ul><li>利用 <code>View</code> 对象构造时创建的 <code>RenderNode</code> 获取一个 <code>SkiaRecordingCanvas</code> “画布”；</li><li>利用 <code>SkiaRecordingCanvas</code> ，在每个子 <code>View</code> 控件的 <code>onDraw</code> 绘制函数中调用 <code>drawLine</code> 、<code>drawRect</code> 等绘制操作时，创建对应的 <code>DisplayListOp</code> 绘制命令，并缓存记录到其内部的 <code>SkiaDisplayList</code> 持有的 <code>DisplayListData</code> 中；</li><li>将包含有 <code>DisplayListOp</code> 绘制命令缓存的 <code>SkiaDisplayList</code> 对象设置填充到 <code>RenderNode</code> 中；</li><li>最后将根 <code>View</code> 的缓存 <code>DisplayListOp</code> 设置到 <code>RootRenderNode</code> 中，完成构建。</li></ul><p><img src="`+Z+'" alt=""><img src="'+H+`" alt=""></p><h3 id="执行渲染绘制任务" tabindex="-1"><a class="header-anchor" href="#执行渲染绘制任务" aria-hidden="true">#</a> 执行渲染绘制任务</h3><p>经过上一小节中的分析，应用在UI线程中从根节点 <code>DecorView</code> 出发，递归遍历每个子 <code>View</code> 节点，搜集其 <code>drawXXX</code> 绘制动作并转换成 <code>DisplayListOp</code> 命令，将其记录到 <code>DisplayListData</code> 并填充到 <code>RenderNode</code> 中，最终完成整个 <code>View</code> 绘制命令树的构建。从此UI线程的绘制任务就完成了。下一步UI线程将唤醒 <code>RenderThread</code> 渲染线程，触发其利用OpenGL执行界面的渲染任务，本小节中我们将重点分析这个流程。我们还是先看看这块代码的简化流程：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>graphics<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>graphics<span class="token operator">/</span><span class="token class-name">HardwareRenderer</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">syncAndDrawFrame</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">FrameInfo</span> frameInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// JNI调用native层的相关函数</span>
    <span class="token keyword">return</span> <span class="token function">nSyncAndDrawFrame</span><span class="token punctuation">(</span>mNativeProxy<span class="token punctuation">,</span> frameInfo<span class="token punctuation">.</span>frameInfo<span class="token punctuation">,</span> frameInfo<span class="token punctuation">.</span>frameInfo<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>libs<span class="token operator">/</span>hwui<span class="token operator">/</span>jni<span class="token operator">/</span>android_graphics_HardwareRenderer<span class="token punctuation">.</span>cpp
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">android_view_ThreadedRenderer_syncAndDrawFrame</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span><span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">,</span>
        jlong proxyPtr<span class="token punctuation">,</span> jlongArray frameInfo<span class="token punctuation">,</span> jint frameInfoSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">RenderProxy</span><span class="token operator">*</span> proxy <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">RenderProxy</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>proxyPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token operator">-&gt;</span><span class="token class-name">GetLongArrayRegion</span><span class="token punctuation">(</span>frameInfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> frameInfoSize<span class="token punctuation">,</span> proxy<span class="token operator">-&gt;</span><span class="token function">frameInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> proxy<span class="token operator">-&gt;</span><span class="token function">syncAndDrawFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>libs<span class="token operator">/</span>hwui<span class="token operator">/</span>renderthread<span class="token operator">/</span><span class="token class-name">RenderProxy</span><span class="token punctuation">.</span>cpp
<span class="token keyword">int</span> <span class="token class-name">RenderProxy</span><span class="token operator">::</span><span class="token function">syncAndDrawFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 唤醒RenderThread渲染线程，执行DrawFrame绘制任务</span>
    <span class="token keyword">return</span> mDrawFrameTask<span class="token punctuation">.</span><span class="token function">drawFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>libs<span class="token operator">/</span>hwui<span class="token operator">/</span>renderthread<span class="token operator">/</span><span class="token class-name">DrawFrameTask</span><span class="token punctuation">.</span>cpp
<span class="token keyword">int</span> <span class="token class-name">DrawFrameTask</span><span class="token operator">::</span><span class="token function">drawFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">postAndWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>libs<span class="token operator">/</span>hwui<span class="token operator">/</span>renderthread<span class="token operator">/</span><span class="token class-name">DrawFrameTask</span><span class="token punctuation">.</span>cpp
<span class="token keyword">void</span> <span class="token class-name">DrawFrameTask</span><span class="token operator">::</span><span class="token function">postAndWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AutoMutex</span> <span class="token function">_lock</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 向RenderThread渲染线程的MessageQueue消息队列放入一个待执行任务，以将其唤醒执行run函数</span>
    mRenderThread<span class="token operator">-&gt;</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// UI线程暂时进入wait等待状态</span>
    mSignal<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>libs<span class="token operator">/</span>hwui<span class="token operator">/</span>renderthread<span class="token operator">/</span><span class="token class-name">DrawFrameTask</span><span class="token punctuation">.</span>cpp
<span class="token keyword">void</span> <span class="token class-name">DrawFrameTask</span><span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 原生标识一帧渲染绘制任务的systrace tag</span>
    <span class="token function">ATRACE_NAME</span><span class="token punctuation">(</span><span class="token string">&quot;DrawFrame&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">TreeInfo</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">TreeInfo</span><span class="token operator">::</span><span class="token constant">MODE_FULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//1.将UI线程构建的DisplayListOp绘制命令树同步到RenderThread渲染线程</span>
        canUnblockUiThread <span class="token operator">=</span> <span class="token function">syncFrameState</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 同步完成后则可以唤醒UI线程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>canUnblockUiThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">unblockUiThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_LIKELY</span><span class="token punctuation">(</span>canDrawThisFrame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.执行draw渲染绘制动作</span>
        context<span class="token operator">-&gt;</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>libs<span class="token operator">/</span>hwui<span class="token operator">/</span>renderthread<span class="token operator">/</span><span class="token class-name">DrawFrameTask</span><span class="token punctuation">.</span>cpp

bool <span class="token class-name">DrawFrameTask</span><span class="token operator">::</span><span class="token function">syncFrameState</span><span class="token punctuation">(</span><span class="token class-name">TreeInfo</span><span class="token operator">&amp;</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 调用CanvasContext的prepareTree函数实现绘制命令树同步的流程</span>
    mContext<span class="token operator">-&gt;</span><span class="token function">prepareTree</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> mFrameInfo<span class="token punctuation">,</span> mSyncQueued<span class="token punctuation">,</span> mTargetNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>libs<span class="token operator">/</span>hwui<span class="token operator">/</span>renderthread<span class="token operator">/</span><span class="token class-name">CanvasContext</span><span class="token punctuation">.</span>cpp
<span class="token keyword">void</span> <span class="token class-name">CanvasContext</span><span class="token operator">::</span><span class="token function">prepareTree</span><span class="token punctuation">(</span><span class="token class-name">TreeInfo</span><span class="token operator">&amp;</span> info<span class="token punctuation">,</span> int64_t<span class="token operator">*</span> uiFrameInfo<span class="token punctuation">,</span> int64_t syncQueued<span class="token punctuation">,</span>
                                <span class="token class-name">RenderNode</span><span class="token operator">*</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RenderNode</span><span class="token punctuation">&gt;</span></span><span class="token operator">&amp;</span> node <span class="token operator">:</span> mRenderNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 递归调用各个子View对应的RenderNode执行prepareTree动作</span>
        node<span class="token operator">-&gt;</span><span class="token function">prepareTree</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>libs<span class="token operator">/</span>hwui<span class="token operator">/</span><span class="token class-name">RenderNode</span><span class="token punctuation">.</span>cpp
<span class="token keyword">void</span> <span class="token class-name">RenderNode</span><span class="token operator">::</span><span class="token function">prepareTree</span><span class="token punctuation">(</span><span class="token class-name">TreeInfo</span><span class="token operator">&amp;</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">prepareTreeImpl</span><span class="token punctuation">(</span>observer<span class="token punctuation">,</span> info<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>libs<span class="token operator">/</span>hwui<span class="token operator">/</span><span class="token class-name">RenderNode</span><span class="token punctuation">.</span>cpp
<span class="token keyword">void</span> <span class="token class-name">RenderNode</span><span class="token operator">::</span><span class="token function">prepareTreeImpl</span><span class="token punctuation">(</span><span class="token class-name">TreeObserver</span><span class="token operator">&amp;</span> observer<span class="token punctuation">,</span> <span class="token class-name">TreeInfo</span><span class="token operator">&amp;</span> info<span class="token punctuation">,</span> bool functorsNeedLayer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token class-name">TreeInfo</span><span class="token operator">::</span><span class="token constant">MODE_FULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 同步绘制命令树</span>
        <span class="token function">pushStagingDisplayListChanges</span><span class="token punctuation">(</span>observer<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDisplayList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 遍历调用各个子View对应的RenderNode的prepareTreeImpl</span>
        bool isDirty <span class="token operator">=</span> mDisplayList<span class="token operator">-&gt;</span><span class="token function">prepareListAndChildren</span><span class="token punctuation">(</span>
                observer<span class="token punctuation">,</span> info<span class="token punctuation">,</span> childFunctorsNeedLayer<span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token class-name">RenderNode</span><span class="token operator">*</span> child<span class="token punctuation">,</span> <span class="token class-name">TreeObserver</span><span class="token operator">&amp;</span> observer<span class="token punctuation">,</span> <span class="token class-name">TreeInfo</span><span class="token operator">&amp;</span> info<span class="token punctuation">,</span>
                   bool functorsNeedLayer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    child<span class="token operator">-&gt;</span><span class="token function">prepareTreeImpl</span><span class="token punctuation">(</span>observer<span class="token punctuation">,</span> info<span class="token punctuation">,</span> functorsNeedLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">RenderNode</span><span class="token operator">::</span><span class="token function">pushStagingDisplayListChanges</span><span class="token punctuation">(</span><span class="token class-name">TreeObserver</span><span class="token operator">&amp;</span> observer<span class="token punctuation">,</span> <span class="token class-name">TreeInfo</span><span class="token operator">&amp;</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">syncDisplayList</span><span class="token punctuation">(</span>observer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">RenderNode</span><span class="token operator">::</span><span class="token function">syncDisplayList</span><span class="token punctuation">(</span><span class="token class-name">TreeObserver</span><span class="token operator">&amp;</span> observer<span class="token punctuation">,</span> <span class="token class-name">TreeInfo</span><span class="token operator">*</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 完成赋值同步DisplayList对象</span>
    mDisplayList <span class="token operator">=</span> mStagingDisplayList<span class="token punctuation">;</span>
    mStagingDisplayList <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">CanvasContext</span><span class="token operator">::</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 1.调用OpenGL库使用GPU，按照构建好的绘制命令完成界面的渲染</span>
    bool drew <span class="token operator">=</span> mRenderPipeline<span class="token operator">-&gt;</span><span class="token function">draw</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> windowDirty<span class="token punctuation">,</span> dirty<span class="token punctuation">,</span> mLightGeometry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mLayerUpdateQueue<span class="token punctuation">,</span>
                                      mContentDrawBounds<span class="token punctuation">,</span> mOpaque<span class="token punctuation">,</span> mLightInfo<span class="token punctuation">,</span> mRenderNodes<span class="token punctuation">,</span>
                                      <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token function">profiler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 2.将前面已经绘制渲染好的图形缓冲区Binder上帧给SurfaceFlinger合成和显示</span>
    bool didSwap <span class="token operator">=</span>
            mRenderPipeline<span class="token operator">-&gt;</span><span class="token function">swapBuffers</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> drew<span class="token punctuation">,</span> windowDirty<span class="token punctuation">,</span> mCurrentFrameInfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>requireSwap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>libs<span class="token operator">/</span>hwui<span class="token operator">/</span>pipeline<span class="token operator">/</span>skia<span class="token operator">/</span><span class="token class-name">SkiaVulkanPipeline</span><span class="token punctuation">.</span>cpp
<span class="token class-name">IRenderPipeline</span><span class="token operator">::</span><span class="token class-name">DrawResult</span> <span class="token class-name">SkiaVulkanPipeline</span><span class="token operator">::</span><span class="token function">draw</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">Frame</span><span class="token operator">&amp;</span> frame<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">SkRect</span><span class="token operator">&amp;</span> screenDirty<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">SkRect</span><span class="token operator">&amp;</span> dirty<span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token class-name">LightGeometry</span><span class="token operator">&amp;</span> lightGeometry<span class="token punctuation">,</span> <span class="token class-name">LayerUpdateQueue</span><span class="token operator">*</span> layerUpdateQueue<span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token class-name">Rect</span><span class="token operator">&amp;</span> contentDrawBounds<span class="token punctuation">,</span> bool opaque<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">LightInfo</span><span class="token operator">&amp;</span> lightInfo<span class="token punctuation">,</span>
        <span class="token keyword">const</span> std<span class="token operator">::</span><span class="token function">vector</span><span class="token generics"><span class="token punctuation">&lt;</span>sp<span class="token punctuation">&lt;</span><span class="token class-name">RenderNode</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token operator">&amp;</span> renderNodes<span class="token punctuation">,</span> <span class="token class-name">FrameInfoVisualizer</span><span class="token operator">*</span> profiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Draw visual debugging features</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span><span class="token class-name">Properties</span><span class="token operator">::</span><span class="token function">showDirtyRegions</span> <span class="token operator">||</span>
                    <span class="token class-name">ProfileType</span><span class="token operator">::</span><span class="token class-name">None</span> <span class="token operator">!=</span> <span class="token class-name">Properties</span><span class="token operator">::</span><span class="token function">getProfileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SkCanvas</span><span class="token operator">*</span> profileCanvas <span class="token operator">=</span> backBuffer<span class="token operator">-&gt;</span><span class="token function">getCanvas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SkiaProfileRenderer</span> <span class="token function">profileRenderer</span><span class="token punctuation">(</span>profileCanvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
        profiler<span class="token operator">-&gt;</span><span class="token function">draw</span><span class="token punctuation">(</span>profileRenderer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    nsecs_t submissionTime <span class="token operator">=</span> <span class="token class-name">IRenderPipeline</span><span class="token operator">::</span><span class="token class-name">DrawResult</span><span class="token operator">::</span><span class="token function">kUnknownTime</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        <span class="token function">ATRACE_NAME</span><span class="token punctuation">(</span><span class="token string">&quot;flush commands&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        submissionTime <span class="token operator">=</span> <span class="token function">vulkanManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finishFrame</span><span class="token punctuation">(</span>backBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    layerUpdateQueue<span class="token operator">-&gt;</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> submissionTime<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

frameworks<span class="token operator">/</span>base<span class="token operator">/</span>libs<span class="token operator">/</span>hwui<span class="token operator">/</span>pipeline<span class="token operator">/</span>skia<span class="token operator">/</span><span class="token class-name">SkiaOpenGLPipeline</span><span class="token punctuation">.</span>cpp
<span class="token class-name">IRenderPipeline</span><span class="token operator">::</span><span class="token class-name">DrawResult</span> <span class="token class-name">SkiaOpenGLPipeline</span><span class="token operator">::</span><span class="token function">draw</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> <span class="token class-name">Frame</span><span class="token operator">&amp;</span> frame<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">SkRect</span><span class="token operator">&amp;</span> screenDirty<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">SkRect</span><span class="token operator">&amp;</span> dirty<span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token class-name">LightGeometry</span><span class="token operator">&amp;</span> lightGeometry<span class="token punctuation">,</span> <span class="token class-name">LayerUpdateQueue</span><span class="token operator">*</span> layerUpdateQueue<span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token class-name">Rect</span><span class="token operator">&amp;</span> contentDrawBounds<span class="token punctuation">,</span> bool opaque<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">LightInfo</span><span class="token operator">&amp;</span> lightInfo<span class="token punctuation">,</span>
        <span class="token keyword">const</span> std<span class="token operator">::</span><span class="token function">vector</span><span class="token generics"><span class="token punctuation">&lt;</span>sp<span class="token punctuation">&lt;</span><span class="token class-name">RenderNode</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token operator">&amp;</span> renderNodes<span class="token punctuation">,</span> <span class="token class-name">FrameInfoVisualizer</span><span class="token operator">*</span> profiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Draw visual debugging features</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CC_UNLIKELY</span><span class="token punctuation">(</span><span class="token class-name">Properties</span><span class="token operator">::</span><span class="token function">showDirtyRegions</span> <span class="token operator">||</span>
                    <span class="token class-name">ProfileType</span><span class="token operator">::</span><span class="token class-name">None</span> <span class="token operator">!=</span> <span class="token class-name">Properties</span><span class="token operator">::</span><span class="token function">getProfileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SkCanvas</span><span class="token operator">*</span> profileCanvas <span class="token operator">=</span> surface<span class="token operator">-&gt;</span><span class="token function">getCanvas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SkiaProfileRenderer</span> <span class="token function">profileRenderer</span><span class="token punctuation">(</span>profileCanvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
        profiler<span class="token operator">-&gt;</span><span class="token function">draw</span><span class="token punctuation">(</span>profileRenderer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">{</span>
        <span class="token function">ATRACE_NAME</span><span class="token punctuation">(</span><span class="token string">&quot;flush commands&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        surface<span class="token operator">-&gt;</span><span class="token function">flushAndSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    layerUpdateQueue<span class="token operator">-&gt;</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">IRenderPipeline</span><span class="token operator">::</span><span class="token class-name">DrawResult</span><span class="token operator">::</span><span class="token function">kUnknownTime</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从以上代码可以看出：UI线程利用 <code>RenderProxy</code> 向 <code>RenderThread</code> 线程发送一个 <code>DrawFrameTask</code> 任务请求， <code>RenderThread</code> 被唤醒，开始渲染，大致流程如下：</p><ul><li><p><code>syncFrameState</code> 中遍历 <code>View</code> 树上每一个 <code>RenderNode</code> ，执行 <code>prepareTreeImpl</code> 函数，实现同步绘制命令树的操作；</p></li><li><p>调用OpenGL库API使用GPU，按照构建好的绘制命令完成界面的渲染（具体过程，由于本文篇幅所限，暂不展开分析）；</p></li><li><p>将前面已经绘制渲染好的图形缓冲区Binder上帧给 <code>SurfaceFlinger</code> 合成和显示；</p></li></ul><p><img src="`+Q+'" alt=""></p><p>从 Perfetto 这个过程如下图所示：</p><p><img src="'+K+'" alt=""></p><h2 id="surfaceflinger-合成显示" tabindex="-1"><a class="header-anchor" href="#surfaceflinger-合成显示" aria-hidden="true">#</a> SurfaceFlinger 合成显示</h2><p><code>SurfaceFlinger</code> 合成显示部分完全属于 Android 系统 GUI 中图形显示的内容，逻辑结构也比较复杂，但不属于本文介绍内容的重点。所以本小节中只是总体上介绍一下其工作原理与思想，不再详细分析源码，感兴趣的读者可以关注笔者后续的文章再来详细分析讲解。简单的说 <code>SurfaceFlinger</code> 作为系统中独立运行的一个 Native 进程，借用Android官网的描述，其职责就是负责接受来自多个来源的数据缓冲区，对它们进行合成，然后发送到显示设备。如下图所示：</p><p><img src="'+Y+'" alt=""></p><p>从上图可以看出，其实 <code>SurfaceFlinger</code> 在Android系统的整个图形显示系统中是起到一个承上启下的作用：</p><ul><li><p>对上：通过 <code>Surface</code> 与不同的应用进程建立联系，接收它们写入 <code>Surface</code> 中的绘制缓冲数据，对它们进行统一合成。</p></li><li><p>对下：通过屏幕的后缓存区与屏幕建立联系，发送合成好的数据到屏幕显示设备。</p></li></ul><p>图形的传递是通过 Buffer 作为载体，Surface 是对 Buffer 的进一步封装，也就是说 Surface 内部具有多个 Buffer 供上层使用，如何管理这些Buffer呢？答案就是BufferQueue ，下面我们来看看BufferQueue的工作原理：</p><h3 id="bufferqueue-机制" tabindex="-1"><a class="header-anchor" href="#bufferqueue-机制" aria-hidden="true">#</a> BufferQueue 机制</h3><p>借用一张经典的图来描述 <code>BufferQueue</code> 的工作原理：</p><p><img src="'+J+'" alt=""></p><p><code>BufferQueue</code> 是一个典型的生产者-消费者模型中的数据结构。在 Android 应用的渲染流程中，应用扮演的就是“生产者”的角色，而 <code>SurfaceFlinger</code> 扮演的则是“消费者”的角色，其配合工作的流程如下：</p><ul><li><p>应用进程中在开始界面的绘制渲染之前，需要通过 Binder 调用 <code>dequeueBuffer</code> 接口从 <code>SurfaceFlinger</code> <code>进程中管理的BufferQueue</code> 中申请一张处于 free 状态的可用 Buffer，如果此时没有可用 Buffer 则阻塞等待；</p></li><li><p>应用进程中拿到这张可用的 Buffer 之后，选择使用 CPU 软件绘制渲染或 GPU 硬件加速绘制渲染，渲染完成后再通过 Binder 调用 <code>queueBuffer</code> 接口将缓存数据返回给应用进程对应的 <code>BufferQueue</code> （如果是 GPU 渲染的话，这里还有个 GPU处理的过程，所以这个 Buffer 不会马上可用，需要等 GPU 渲染完成的 Fence 信号），并申请sf类型的 Vsync 以便唤醒“消费者” <code>SurfaceFlinger</code> 进行消费；</p></li><li><p><code>SurfaceFlinger</code> 在收到 Vsync 信号之后，开始准备合成，使用 <code>acquireBuffer</code> 获取应用对应的 <code>BufferQueue</code> 中的 Buffer 并进行合成操作；</p></li><li><p>合成结束后， <code>SurfaceFlinger</code> 将通过调用 <code>releaseBuffer</code> 将 Buffer 置为可用的 free 状态，返回到应用对应的 <code>BufferQueue</code> 中。</p></li></ul><h3 id="vsync-同步机制" tabindex="-1"><a class="header-anchor" href="#vsync-同步机制" aria-hidden="true">#</a> Vsync 同步机制</h3><p>VSYNC 垂直同步是 Android 在“黄油计划”中引入的一个重要机制，本质上是为了协调 <code>BufferQueue</code> 的应用生产者生成UI数据动作和 <code>SurfaceFlinger</code> 消费者的合成消费动作，避免出现画面撕裂的Tearing现象。 VSYNC 信号分为两种类型：</p><ul><li><p>app 类型的 Vsync ：app 类型的 Vsync 信号由上层应用中的 <code>Choreographer</code> 根据绘制需求进行注册和接收，用于控制应用UI绘制上帧的生产节奏。根据第7小结中的分析：应用在UI线程中调用 <code>invalidate</code> 刷新界面绘制时，需要先透过 <code>Choreographer</code> 向系统申请注册 app 类型的 Vsync 信号，待 Vsync 信号到来后，才能往主线程的消息队列放入待绘制任务进行真正UI的绘制动作；</p></li><li><p>sf 类型的 Vsync : sf 类型的 Vsync 是用于控制 <code>SurfaceFlinger</code> 的合成消费节奏。应用完成界面的绘制渲染后，通过 Binder 调用 <code>queueBuffer</code> 接口将缓存数据返还给应用对应的 BufferQueue 时，会申请sf类型的Vsync，待 <code>SurfaceFlinger</code> 在其UI线程中收到 Vsync 信号之后，便开始进行界面的合成操作。</p></li></ul><p>Vsync 信号的生成是参考屏幕硬件的刷新周期的，其架构如下图所示：</p><p><img src="'+X+'" alt=""></p><p>本小节所描述的流程，从 Perfetto 上看 <code>SurfaceFlinger</code> 处理应用上帧工作的流程如下图所示：</p><p><img src="'+$+'" alt=""></p><p><img src="'+nn+'" alt=""></p><h2 id="其他" tabindex="-1"><a class="header-anchor" href="#其他" aria-hidden="true">#</a> 其他</h2><h3 id="android中的-epoll" tabindex="-1"><a class="header-anchor" href="#android中的-epoll" aria-hidden="true">#</a> Android中的 epoll</h3><p>在 Android 中，epoll 是一种事件通知机制，用于处理 I/O 事件的多路复用。它是基于 Linux 的 epoll 概念进行实现的，提供了高效的事件管理和触发机制，常用于网络编程和异步 I/O 操作。</p><p>epoll 的工作原理如下：</p><ol><li><p>创建 epoll 实例：首先需要创建一个 epoll 实例，通过调用 <code>epoll_create</code> 函数完成。</p></li><li><p>注册文件描述符：将需要监视的文件描述符注册到 epoll 实例中，可以使用 <code>epoll_ctl</code> 函数完成注册操作。注册时需要指定感兴趣的事件类型，如可读事件、可写事件等。</p></li><li><p>等待事件触发：调用 <code>epoll_wait</code> 函数等待事件的发生。当注册的文件描述符中有事件发生时，epoll_wait 函数会返回触发事件的文件描述符列表。</p></li><li><p>处理事件：根据返回的文件描述符列表，进行相应的事件处理操作。可以通过检查事件的类型来确定具体的操作，如读取数据、发送数据等。</p></li></ol><p>使用 epoll 机制可以有效地监视多个文件描述符的事件，而不需要通过轮询方式不断检查每个文件描述符的状态。这样可以提高系统的性能和效率，尤其在处理大量并发连接的网络应用中表现出色。</p><p>在 Android 中，epoll 机制被广泛应用于网络编程、异步 I/O 操作以及事件驱动的框架和库中，如 Android 的网络库、Socket 通信、JNI 开发等场景。</p><h3 id="perfetto中的-sys-read" tabindex="-1"><a class="header-anchor" href="#perfetto中的-sys-read" aria-hidden="true">#</a> Perfetto中的 sys_read</h3><p><code>sys_read</code> 是 Linux 内核中的系统调用之一，用于从文件描述符中读取数据。在 Perfetto 中，它表示读取文件系统的操作，可以用来监测读取文件的行为，包括读取的大小、读取的时间和读取的文件描述符等信息。通过分析这些数据，可以得出一些关于应用程序性能的结论，例如文件读取的频率、文件大小和读取时间等。这些信息对于优化应用程序的磁盘访问行为非常有用。在 Perfetto 中，sys_read 这个事件会被记录在 ftrace 的 event 文件中。</p><h3 id="perfetto中的-sys-write" tabindex="-1"><a class="header-anchor" href="#perfetto中的-sys-write" aria-hidden="true">#</a> Perfetto中的 sys_write</h3><p>在 Perfetto 的追踪记录中，<code>sys_write</code> 表示正在进行的写操作。这通常涉及将数据写入文件、管道或其他输出设备。它是 Linux 内核提供的系统调用之一，允许程序向文件描述符写入数据。</p><p>在 Perfetto 中，<code>sys_write</code> 通常与应用程序和内核的 I/O 操作相关。通过跟踪 <code>sys_write</code> 系统调用，可以了解应用程序和内核之间的 I/O 操作，以及它们对系统性能的影响。Perfetto 的追踪记录可以用于分析应用程序性能瓶颈，诊断内核和驱动程序问题，以及确定系统瓶颈的根本原因。</p><h3 id="perfetto中的-sys-ioctl" tabindex="-1"><a class="header-anchor" href="#perfetto中的-sys-ioctl" aria-hidden="true">#</a> Perfetto中的 sys_ioctl</h3><p>在 Linux 中，<code>ioctl</code> 是一个系统调用（system call），它可以用来对文件描述符执行各种控制操作。<code>ioctl</code> 的参数通常是一个整数（表示要执行的操作），以及一个结构体（用于输入或输出控制信息）。常见的用法包括控制硬件设备（如串口、网卡、声卡等）以及控制虚拟文件系统（如 <code>/proc</code>、<code>/sys</code> 等）。</p><p>在 Perfetto 中，<code>sys_ioctl</code> 是一个事件（event），表示执行了一个 <code>ioctl</code> 系统调用。通常会记录下 <code>ioctl</code> 的参数（如文件描述符、操作码、输入/输出参数等）以及相应的返回值。通过这些信息，可以分析出应用程序或系统内核的行为。例如，可能会分析某个应用程序使用 <code>ioctl</code> 控制了硬件设备的哪些参数，或者分析内核对文件系统的控制操作。</p><h3 id="perfetto中的-sys-epoll-pwait" tabindex="-1"><a class="header-anchor" href="#perfetto中的-sys-epoll-pwait" aria-hidden="true">#</a> Perfetto中的 sys_epoll_pwait</h3><p><code>sys_epoll_pwait</code> 是 Linux 内核中的系统调用，主要用于实现异步 I/O 和事件通知。<code>epoll</code> 是 Linux 中高效的 I/O 多路复用机制之一，<code>sys_epoll_pwait</code> 则是在 <code>epoll</code> 机制的基础上提供的等待事件发生的系统调用，可以等待一个或多个文件描述符上的指定事件集合发生，直到事件就绪或者超时为止。当指定的事件发生时，<code>sys_epoll_pwait</code> 返回事件相关的文件描述符和事件类型，以便应用程序进行处理。</p><p>在 Perfetto 中，<code>sys_epoll_pwait</code> 可能会被用于实现异步事件跟踪，通过在 Perfetto 中设置特定的跟踪事件，可以使用 <code>sys_epoll_pwait</code> 来等待事件发生并进行处理。例如，可以设置 Perfetto 跟踪网络通信事件，通过 <code>sys_epoll_pwait</code> 等待网络事件发生并记录跟踪信息。</p><h3 id="perfetto中的-sys-recvmsg" tabindex="-1"><a class="header-anchor" href="#perfetto中的-sys-recvmsg" aria-hidden="true">#</a> Perfetto中的 sys_recvmsg</h3><p><code>sys_recvmsg</code> 是一个 Linux 内核系统调用，用于接收一段网络数据。在 Perfetto 中，<code>sys_recvmsg</code> 的事件指示在系统中调用此函数的相关信息，包括函数参数和返回值等等。</p><p>Perfetto 是一个系统级的跟踪工具，能够收集各种系统事件和指标，并将其导出为跨平台的可视化数据。它可以用于调试和分析各种系统问题，包括性能瓶颈、功耗问题、安全漏洞等等。</p><h3 id="system-core-rootdir-init-rc-system-core-rootdir-init-zygote64-rc" tabindex="-1"><a class="header-anchor" href="#system-core-rootdir-init-rc-system-core-rootdir-init-zygote64-rc" aria-hidden="true">#</a> system/core/rootdir/init.rc &amp;&amp; system/core/rootdir/init.zygote64.rc</h3><p>这段代码是 Android 系统 init 进程中的一个服务定义，用于启动 zygote 进程。zygote 进程是 Android 系统中的一个关键进程，用于启动和管理应用程序。以下是代码中各行的分析：</p><ol><li><code>service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server</code>: 定义一个名为 &quot;zygote&quot; 的服务，使用 <code>/system/bin/app_process64</code> 作为可执行文件，其后的参数用于指定启动 zygote 进程及系统服务。</li><li><code>class main</code>: 将 zygote 服务归类为主要服务。</li><li><code>priority -20</code>: 为 zygote 服务设置优先级 -20。这表示它具有较高的优先级。</li><li><code>user root</code>: 以 root 用户身份运行 zygote 服务。</li><li><code>group root readproc reserved_disk</code>: 为 zygote 服务设置组权限，包括 root、readproc 和 reserved_disk。</li><li><code>socket zygote stream 660 root system</code>: 创建名为 zygote 的 UNIX 域套接字，用于与其他进程通信。</li><li><code>socket usap_pool_primary stream 660 root system</code>: 创建名为 usap_pool_primary 的 UNIX 域套接字，用于与其他进程通信。</li><li><code>onrestart ...</code>: 定义在 zygote 服务重启时要执行的一系列操作，例如重启其他系统服务、恢复系统电源状态等。</li><li><code>task_profiles ProcessCapacityHigh</code>: 将 zygote 服务的任务配置文件设置为 ProcessCapacityHigh，表示这是一个高容量进程。</li><li><code>critical window=${zygote.critical_window.minute:-off} target=zygote-fatal</code>: 设置 zygote 服务的关键窗口，若在这个时间内出现关键错误，将触发名为 zygote-fatal 的操作。</li></ol><p>总结：这段代码负责启动和配置 Android 系统中的 zygote 服务，它是一个关键服务，用于启动和管理应用程序。代码定义了 zygote 服务的运行参数、通信套接字、重启操作以及优先级等配置。</p><h2 id="引用" tabindex="-1"><a class="header-anchor" href="#引用" aria-hidden="true">#</a> 引用</h2>',206),on={href:"https://www.jianshu.com/p/37370c1d17fc",target:"_blank",rel:"noopener noreferrer"},cn={href:"https://blog.csdn.net/u013028621/article/details/116271537",target:"_blank",rel:"noopener noreferrer"};function ln(un,kn){const a=c("ExternalLinkIcon");return l(),i("div",null,[an,pn,n("p",null,[s("对优秀文章"),n("a",tn,[s("《Android应用启动全流程分析（源码深度剖析）》"),p(a)]),s("学习的记录")]),en,n("ul",null,[n("li",null,[n("a",on,[s("https://www.jianshu.com/p/37370c1d17fc"),p(a)])]),n("li",null,[n("a",cn,[s("https://blog.csdn.net/u013028621/article/details/116271537"),p(a)])])])])}const dn=o(sn,[["render",ln],["__file","app-launch.html.vue"]]);export{dn as default};
