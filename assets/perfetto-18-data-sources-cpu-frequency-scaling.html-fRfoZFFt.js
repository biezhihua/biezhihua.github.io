import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{e as t,f as r,o as n}from"./app-D4ZtVCQo.js";const c={};function s(p,e){return n(),t("div",null,e[0]||(e[0]=[r('<h1 id="perfetto-18-cpu-frequency-and-idle-states-cpu频率和空闲状态" tabindex="-1"><a class="header-anchor" href="#perfetto-18-cpu-frequency-and-idle-states-cpu频率和空闲状态"><span>Perfetto - 18 - CPU frequency and idle states CPU频率和空闲状态</span></a></h1><p>Frequency scaling的翻译为“频率缩放”，它是指通过改变CPU的时钟频率来控制CPU的功耗和性能的一种技术。在现代的计算机系统中，CPU是消耗大量电力的设备，频率缩放技术可以通过降低CPU的时钟频率来降低功耗，并延长电池寿命。同时，当需要更高的性能时，频率缩放技术也可以通过增加CPU的时钟频率来提高CPU的性能。频率缩放技术通常由操作系统内核或硬件设备自动控制，并在不同的应用程序或任务之间动态调整CPU的时钟频率，以实现更好的平衡功耗和性能之间的权衡。</p><h2 id="basic" tabindex="-1"><a class="header-anchor" href="#basic"><span>Basic</span></a></h2><p>该数据源在Linux和Android (Since P)上可用。它通过Linux内核ftrace基础设施记录CPU电源管理方案的变化。它涉及三个方面:</p><h3 id="频率扩展" tabindex="-1"><a class="header-anchor" href="#频率扩展"><span>频率扩展</span></a></h3><p>获取CPU频率数据有两种方式:</p><ul><li>开启power/cpu_frequency ftrace事件。(参见下面的TraceConfig)。这将在内核内cpufreq缩放驱动程序每次改变频率时记录一个事件。请注意，并非所有平台都支持这一点。根据我们的经验，它在基于arm的soc上可靠地工作，但在大多数基于英特尔的现代平台上不产生数据。这是因为最近的Intel CPU使用的是由CPU直接控制的内部DVFS，这不会将频率变化事件暴露给内核。还要注意，即使在基于arm的平台上，事件也只在CPU频率发生变化时才会触发。在许多情况下，CPU频率几秒钟内都不会改变，它将在跟踪开始时显示为一个空块。我们建议始终将此与轮询(如下)结合起来，以获得初始频率的可靠快照。</li><li>通过启用linux轮询sysfs。Sys_stats数据源，并将cpufreq_period_ms设置为值&gt;0. 这将周期性地轮询/sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq，并在跟踪缓冲区中记录当前值。适用于基于Intel和arm的平台。</li></ul><p>在大多数Android设备上，频率缩放是按集群(大/小核组)进行的，所以四个cpu组同时改变频率是很正常的。</p><h3 id="可用的频率" tabindex="-1"><a class="header-anchor" href="#可用的频率"><span>可用的频率</span></a></h3><p>通过启用linux，可以一次性记录每个CPU支持的频率的完整列表。System_info数据源。这将在跟踪记录开始时记录/sys/devices/system/cpu/cpu*/cpufreq/scaling_available_frequencies。该信息通常用于通过检查cpu_freq表来区分大/小核。</p><p>由于前面提到的power/cpu_frequency的原因，现代英特尔平台不支持这一功能。</p><h3 id="空闲状态" tabindex="-1"><a class="header-anchor" href="#空闲状态"><span>空闲状态</span></a></h3><p>当没有线程有资格被执行时(例如，它们都处于睡眠状态)，内核将CPU设置为空闲状态，关闭一些电路以减少空闲电源的使用。大多数现代cpu都有不止一个空闲状态:更深层的空闲状态耗电量更少，但也需要更多时间恢复。</p><p>请注意，空闲转换是相对快速和廉价的，CPU可以在一秒钟内进入和离开空闲状态数百次。不应将空闲状态与完全设备挂起相混淆，后者是一种更强且更具侵入性的省电状态(见下文)。即使屏幕开着，设备看起来也在运行，cpu也可能处于空闲状态。</p><p>关于有多少空闲状态可用以及它们的语义是高度特定于CPU/SoC的。在跟踪级别，空闲状态0表示非空闲，大于0的值表示越来越深的省电状态(例如，单核空闲-&gt;全包空闲)。</p><p>请注意，只要插入USB线，大多数Android设备就不会进入空闲状态(USB驱动程序堆栈拥有wakelocks)。在通过USB收集的痕迹中只看到一个空闲状态是很正常的。</p><p>在大多数soc上，当CPU空闲时，频率没有什么价值，因为CPU通常处于空闲状态。在这些情况下，跟踪中的频率恰好是CPU在空闲之前运行的最后一个频率。</p><h3 id="已知问题" tabindex="-1"><a class="header-anchor" href="#已知问题"><span>已知问题:</span></a></h3><p>只有在频率发生变化时才会触发该事件。这种情况可能不会持续很长一段时间。在简短的跟踪中，有些CPU可能不报告任何事件，在跟踪的左侧显示一个间隙，或者根本不报告。Perfetto当前不记录跟踪启动时的初始cpu频率。</p><p>目前，如果未捕获空闲状态(见下文)，UI不会呈现cpufreq跟踪。这是一个只有ui的错误，即使没有显示，数据也可以通过跟踪处理器记录和查询。</p><h2 id="ui" tabindex="-1"><a class="header-anchor" href="#ui"><span>UI</span></a></h2><p>在用户界面中，CPU频率和空闲状态显示在同一轨道上。轨道的高度表示频率，颜色表示空闲状态(彩色表示非空闲，灰色表示空闲)。悬停或点击轨道上的一个点将显示频率和空闲状态:</p><h2 id="sql" tabindex="-1"><a class="header-anchor" href="#sql"><span>SQL</span></a></h2><h2 id="traceconfig" tabindex="-1"><a class="header-anchor" href="#traceconfig"><span>TraceConfig</span></a></h2><h2 id="full-device-suspend" tabindex="-1"><a class="header-anchor" href="#full-device-suspend"><span>Full-device suspend</span></a></h2><p>当笔记本电脑处于“睡眠”模式(例如关闭盖子)或智能手机显示屏关闭足够时间时，就会发生设备完全暂停。</p><p>当设备挂起时，大多数硬件单元都关闭，进入尽可能高的省电状态(完全关机除外)。</p><p>请注意，大多数Android设备在调暗显示器后不会立即暂停，但如果通过电源按钮强制关闭显示器，则倾向于这样做。细节是高度特定于设备/制造商/内核的。</p><p>已知问题:</p><p>UI没有清楚地显示挂起状态。当Android设备挂起时，看起来好像所有CPU都在运行kmigration线程，而一个CPU在运行power HAL。</p><h2 id="reference" tabindex="-1"><a class="header-anchor" href="#reference"><span>Reference</span></a></h2><ul><li>https://perfetto.dev/docs/data-sources/cpu-freq</li></ul>',32)]))}const d=a(c,[["render",s],["__file","perfetto-18-data-sources-cpu-frequency-scaling.html.vue"]]),u=JSON.parse('{"path":"/learn-android/perfetto/perfetto-18-data-sources-cpu-frequency-scaling.html","title":"Perfetto - 18 - CPU frequency and idle states CPU频率和空闲状态","lang":"zh-CN","frontmatter":{"article":false,"description":"Perfetto - 18 - CPU frequency and idle states CPU频率和空闲状态 Frequency scaling的翻译为“频率缩放”，它是指通过改变CPU的时钟频率来控制CPU的功耗和性能的一种技术。在现代的计算机系统中，CPU是消耗大量电力的设备，频率缩放技术可以通过降低CPU的时钟频率来降低功耗，并延长电池寿命。...","head":[["meta",{"property":"og:url","content":"https://github.com/biezhihua/learn-android/perfetto/perfetto-18-data-sources-cpu-frequency-scaling.html"}],["meta",{"property":"og:site_name","content":"biezhihua的日常"}],["meta",{"property":"og:title","content":"Perfetto - 18 - CPU frequency and idle states CPU频率和空闲状态"}],["meta",{"property":"og:description","content":"Perfetto - 18 - CPU frequency and idle states CPU频率和空闲状态 Frequency scaling的翻译为“频率缩放”，它是指通过改变CPU的时钟频率来控制CPU的功耗和性能的一种技术。在现代的计算机系统中，CPU是消耗大量电力的设备，频率缩放技术可以通过降低CPU的时钟频率来降低功耗，并延长电池寿命。..."}],["meta",{"property":"og:type","content":"website"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-03-08T14:25:34.000Z"}],["meta",{"property":"article:modified_time","content":"2025-03-08T14:25:34.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"WebPage\\",\\"name\\":\\"Perfetto - 18 - CPU frequency and idle states CPU频率和空闲状态\\",\\"description\\":\\"Perfetto - 18 - CPU frequency and idle states CPU频率和空闲状态 Frequency scaling的翻译为“频率缩放”，它是指通过改变CPU的时钟频率来控制CPU的功耗和性能的一种技术。在现代的计算机系统中，CPU是消耗大量电力的设备，频率缩放技术可以通过降低CPU的时钟频率来降低功耗，并延长电池寿命。...\\"}"]]},"git":{"createdTime":1679590127000,"updatedTime":1741443934000,"contributors":[{"name":"biezhihua","username":"biezhihua","email":"biezhihua@gmail.com","commits":5,"url":"https://github.com/biezhihua"}]},"readingTime":{"minutes":4.93,"words":1479},"filePathRelative":"learn-android/perfetto/perfetto-18-data-sources-cpu-frequency-scaling.md","localizedDate":"2023年3月23日","excerpt":"","autoDesc":true}');export{d as comp,u as data};
